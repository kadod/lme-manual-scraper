# Phase 3: ãƒ•ã‚©ãƒ¼ãƒ æ©Ÿèƒ½ å®Œå…¨å®Ÿè£…è¨ˆç”»æ›¸

**ä½œæˆæ—¥**: 2025-10-29
**å¯¾è±¡**: L Message SaaS - ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ»å›ç­”ç®¡ç†æ©Ÿèƒ½
**æ¨å®šæœŸé–“**: Week 6-7 (2é€±é–“)
**å„ªå…ˆåº¦**: ğŸŸ¢ Medium (Phase 3 - Advanced)

---

## ğŸ“‹ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

Phase 3ã§ã¯ã€ã‚¨ãƒ«ãƒ¡ã®ä¸»è¦æ©Ÿèƒ½ã®ä¸€ã¤ã§ã‚ã‚‹ã€Œãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ©Ÿèƒ½ã€ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã“ã®æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã€äºˆç´„ã€ç”³ã—è¾¼ã¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã§ãã€LINEå‹ã ã¡ã‹ã‚‰å›ç­”ã‚’åé›†ã—ã€è‡ªå‹•å¿œç­”ã¨é€£æºã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### Phase 3ã®ç›®æ¨™

- **ãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ€ãƒ¼**: ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§11ç¨®é¡ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ã‚’é…ç½®
- **ãƒ•ã‚©ãƒ¼ãƒ å›ç­”ç®¡ç†**: å›ç­”ãƒ‡ãƒ¼ã‚¿ã®åé›†ã€é–²è¦§ã€CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- **å…¬é–‹URLç”Ÿæˆ**: ãƒ•ã‚©ãƒ¼ãƒ ã‚’LINEå¤–éƒ¨ã§å…¬é–‹ã§ãã‚‹URLç™ºè¡Œ
- **è‡ªå‹•å¿œç­”é€£æº**: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å¾Œã®ã‚µãƒ³ã‚¯ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¿ã‚°ä»˜ä¸
- **æ¡ä»¶åˆ†å²æ©Ÿèƒ½**: å›ç­”å†…å®¹ã«å¿œã˜ãŸå‹•çš„ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º

---

## ğŸ¯ æ©Ÿèƒ½è¦ä»¶å®šç¾©

### 1. ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ©Ÿèƒ½

#### 1.1 ãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ€ãƒ¼ UI

**ç”»é¢**: `/dashboard/forms/new`

**ä¸»è¦æ©Ÿèƒ½**:
- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é…ç½®
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¸¦ã³æ›¿ãˆ
- ãƒ•ã‚©ãƒ¼ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
- ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜æ–‡ã€é€ä¿¡ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰
- ãƒ‡ã‚¶ã‚¤ãƒ³ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã€èƒŒæ™¯ç”»åƒï¼‰

**UXãƒ•ãƒ­ãƒ¼**:
```
1. ã€Œæ–°è¦ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
2. ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›
3. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°
4. ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­å®šï¼ˆãƒ©ãƒ™ãƒ«ã€å¿…é ˆé …ç›®ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
5. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª
6. ä¿å­˜ â†’ å…¬é–‹URLç™ºè¡Œ
```

#### 1.2 ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ï¼ˆ11ç¨®é¡ï¼‰

**ä»•æ§˜å‡ºå…¸**: `lme_saas_features_complete.md` - Line 119

| No | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ— | èª¬æ˜ | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
|----|----------------|------|---------------|
| 1 | **ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ1è¡Œï¼‰** | çŸ­ã„æ–‡å­—å…¥åŠ› | æœ€å¤§æ–‡å­—æ•°ã€æ–‡å­—ç¨®åˆ¶é™ |
| 2 | **ãƒ†ã‚­ã‚¹ãƒˆï¼ˆè¤‡æ•°è¡Œï¼‰** | é•·æ–‡å…¥åŠ› | æœ€å¤§æ–‡å­—æ•° |
| 3 | **ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹** | ãƒ¡ãƒ¼ãƒ«å…¥åŠ› | ãƒ¡ãƒ¼ãƒ«å½¢å¼æ¤œè¨¼ |
| 4 | **é›»è©±ç•ªå·** | é›»è©±ç•ªå·å…¥åŠ› | é›»è©±ç•ªå·å½¢å¼æ¤œè¨¼ |
| 5 | **æ•°å€¤** | æ•°å€¤å…¥åŠ› | æœ€å°å€¤/æœ€å¤§å€¤ã€æ•´æ•°/å°æ•° |
| 6 | **æ—¥ä»˜** | æ—¥ä»˜é¸æŠ | æ—¥ä»˜ç¯„å›²åˆ¶é™ |
| 7 | **æ™‚åˆ»** | æ™‚åˆ»é¸æŠ | æ™‚åˆ»ç¯„å›²åˆ¶é™ |
| 8 | **å˜ä¸€é¸æŠï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼‰** | 1ã¤ã ã‘é¸æŠ | å¿…é ˆ/ä»»æ„ |
| 9 | **è¤‡æ•°é¸æŠï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰** | è¤‡æ•°é¸æŠå¯èƒ½ | æœ€å°/æœ€å¤§é¸æŠæ•° |
| 10 | **ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³** | ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ | å¿…é ˆ/ä»»æ„ |
| 11 | **ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰** | ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ | ãƒ•ã‚¡ã‚¤ãƒ«ç¨®é¡ã€æœ€å¤§ã‚µã‚¤ã‚º |

#### 1.3 ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å…±é€šè¨­å®šé …ç›®

```typescript
interface FormField {
  id: string
  type: FieldType
  label: string
  placeholder?: string
  description?: string
  required: boolean
  order: number

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  validation?: {
    minLength?: number
    maxLength?: number
    min?: number
    max?: number
    pattern?: string
    allowedFileTypes?: string[]
    maxFileSize?: number
  }

  // é¸æŠè‚¢ï¼ˆãƒ©ã‚¸ã‚ªã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ç”¨ï¼‰
  options?: {
    value: string
    label: string
  }[]

  // æ¡ä»¶åˆ†å²
  conditions?: {
    showIf?: {
      fieldId: string
      operator: 'equals' | 'contains' | 'greaterThan' | 'lessThan'
      value: string
    }[]
  }
}
```

#### 1.4 ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šé …ç›®

```typescript
interface Form {
  id: string
  organizationId: string
  channelId: string

  // åŸºæœ¬æƒ…å ±
  title: string
  description?: string
  status: 'draft' | 'published' | 'closed'

  // å…¬é–‹è¨­å®š
  publicUrl: string
  isPublic: boolean
  publishedAt?: Date
  closedAt?: Date

  // ãƒ‡ã‚¶ã‚¤ãƒ³
  theme: {
    primaryColor: string
    backgroundColor: string
    fontFamily: string
  }

  // ãƒœã‚¿ãƒ³è¨­å®š
  submitButtonText: string

  // å›ç­”å¾Œã®å‹•ä½œ
  afterSubmit: {
    showMessage: boolean
    messageText?: string
    redirectUrl?: string
    addTags?: string[] // ã‚¿ã‚°IDã®é…åˆ—
    sendLineMessage?: {
      enabled: boolean
      messageId?: string
    }
  }

  // åˆ¶é™
  limits: {
    maxSubmissions?: number
    oneSubmissionPerUser: boolean
    requireAuthentication: boolean
  }

  // é€šçŸ¥è¨­å®š
  notifications: {
    enabled: boolean
    emailRecipients?: string[]
    lineNotify?: boolean
  }

  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  createdBy: string
  createdAt: Date
  updatedAt: Date
}
```

---

### 2. ãƒ•ã‚©ãƒ¼ãƒ å›ç­”ç®¡ç†æ©Ÿèƒ½

#### 2.1 å›ç­”ä¸€è¦§ç”»é¢

**ç”»é¢**: `/dashboard/forms/[id]/submissions`

**ä¸»è¦æ©Ÿèƒ½**:
- å›ç­”ãƒ‡ãƒ¼ã‚¿ã®ä¸€è¦§è¡¨ç¤ºï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ï¼‰
- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆæ—¥ä»˜ç¯„å›²ã€å‹ã ã¡ã€ã‚¿ã‚°ï¼‰
- ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆé€ä¿¡æ—¥æ™‚ã€å‹ã ã¡åï¼‰
- æ¤œç´¢æ©Ÿèƒ½ï¼ˆå›ç­”å†…å®¹ã§æ¤œç´¢ï¼‰
- å›ç­”è©³ç´°è¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
- ä¸€æ‹¬æ“ä½œï¼ˆå‰Šé™¤ã€ã‚¿ã‚°ä»˜ä¸ã€CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰

**ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ©ãƒ ä¾‹**:
| é€ä¿¡æ—¥æ™‚ | å‹ã ã¡å | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰1 | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰2 | ... | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|---------|---------|-----------|-----------|-----|----------|
| 2025-10-29 10:30 | ç”°ä¸­å¤ªéƒ | å›ç­”å†…å®¹ | å›ç­”å†…å®¹ | ... | è©³ç´°/å‰Šé™¤ |

#### 2.2 å›ç­”è©³ç´°è¡¨ç¤º

**æ©Ÿèƒ½**:
- å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å›ç­”å†…å®¹è¡¨ç¤º
- é€ä¿¡å…ƒå‹ã ã¡æƒ…å ±è¡¨ç¤º
- IPã‚¢ãƒ‰ãƒ¬ã‚¹ã€User-Agentè¡¨ç¤º
- ã‚¿ã‚°ä»˜ä¸/å‰Šé™¤
- LINEé€šçŸ¥é€ä¿¡
- å›ç­”ã®ç·¨é›†ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
- å›ç­”ã®å‰Šé™¤

#### 2.3 CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

**å‡ºåŠ›å½¢å¼**:
```csv
é€ä¿¡æ—¥æ™‚,å‹ã ã¡å,LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ID,ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰1,ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰2,...
2025-10-29 10:30:00,ç”°ä¸­å¤ªéƒ,U1234567890,å›ç­”1,å›ç­”2,...
```

**ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š**:
- æœŸé–“æŒ‡å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é¸æŠã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- æ–‡å­—ã‚³ãƒ¼ãƒ‰é¸æŠï¼ˆUTF-8, Shift-JISï¼‰
- ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨å¾Œã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

---

### 3. å…¬é–‹URLç”Ÿæˆæ©Ÿèƒ½

#### 3.1 URLç”Ÿæˆä»•æ§˜

**URLå½¢å¼**:
```
https://yourdomain.com/f/{form_slug}
```

**æ©Ÿèƒ½**:
- çŸ­ç¸®URLç”Ÿæˆ
- ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ©ãƒƒã‚°è¨­å®š
- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆå…¬é–‹URLç”¨ï¼‰
- URLåŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆiframeï¼‰

#### 3.2 ãƒ•ã‚©ãƒ¼ãƒ å…¬é–‹ãƒšãƒ¼ã‚¸

**ç”»é¢**: `/f/[form_slug]`

**ä¸»è¦æ©Ÿèƒ½**:
- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆPC/ã‚¹ãƒãƒ›å¯¾å¿œï¼‰
- ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
- é€ä¿¡å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
- LIFFé€£æºï¼ˆLINEå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ãŸå ´åˆã€å‹ã ã¡æƒ…å ±ã‚’è‡ªå‹•å–å¾—ï¼‰

**LIFFé€£æºãƒ•ãƒ­ãƒ¼**:
```
1. LINEãƒˆãƒ¼ã‚¯å†…ã§ãƒ•ã‚©ãƒ¼ãƒ URLã‚’ã‚¯ãƒªãƒƒã‚¯
2. LIFFèµ·å‹• â†’ LINEå‹ã ã¡æƒ…å ±å–å¾—
3. ãƒ•ã‚©ãƒ¼ãƒ å›ç­”ã‚’å‹ã ã¡ã«ç´ä»˜ã‘ã¦ä¿å­˜
4. ã‚µãƒ³ã‚¯ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è‡ªå‹•é€ä¿¡
```

---

### 4. è‡ªå‹•å¿œç­”é€£æºæ©Ÿèƒ½

#### 4.1 ã‚µãƒ³ã‚¯ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡

**ãƒˆãƒªã‚¬ãƒ¼**: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å®Œäº†æ™‚

**è¨­å®šé …ç›®**:
```typescript
interface FormAutoReply {
  enabled: boolean
  messageType: 'text' | 'flex' | 'template'
  messageContent: LineMessage
  delaySeconds: number // é€ä¿¡é…å»¶ï¼ˆç§’ï¼‰
}
```

**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¾‹**:
```
ã”å›ç­”ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼
å†…å®¹ã‚’ç¢ºèªæ¬¡ç¬¬ã€æ‹…å½“è€…ã‚ˆã‚Šã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚

ã€å›ç­”å†…å®¹ã€‘
ãŠåå‰: {{field_name}}
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: {{field_email}}
```

#### 4.2 ã‚¿ã‚°è‡ªå‹•ä»˜ä¸

**ãƒˆãƒªã‚¬ãƒ¼**: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å®Œäº†æ™‚

**è¨­å®šé …ç›®**:
- ä»˜ä¸ã™ã‚‹ã‚¿ã‚°ã®é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰
- æ¡ä»¶ä»˜ãä»˜ä¸ï¼ˆç‰¹å®šã®å›ç­”å†…å®¹ã®å ´åˆã®ã¿ï¼‰

**æ¡ä»¶ä¾‹**:
```
ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€Œèˆˆå‘³ã®ã‚ã‚‹å•†å“ã€ãŒã€Œãƒ—ãƒ©ãƒ³Aã€ã®å ´åˆ
â†’ ã‚¿ã‚°ã€Œãƒ—ãƒ©ãƒ³Aå¸Œæœ›è€…ã€ã‚’è‡ªå‹•ä»˜ä¸
```

#### 4.3 ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡ãƒˆãƒªã‚¬ãƒ¼

**ãƒˆãƒªã‚¬ãƒ¼**: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å®Œäº†æ™‚

**è¨­å®šé …ç›®**:
- ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®é¸æŠ
- ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ï¼ˆç„¡æ¡ä»¶ or å›ç­”å†…å®¹ã§æ¡ä»¶åˆ†å²ï¼‰

---

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆ

### 3ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆ

#### Table 1: `forms` (ãƒ•ã‚©ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼)

```sql
CREATE TABLE forms (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  channel_id UUID NOT NULL REFERENCES line_channels(id) ON DELETE CASCADE,

  -- åŸºæœ¬æƒ…å ±
  title TEXT NOT NULL,
  description TEXT,
  slug TEXT UNIQUE NOT NULL, -- å…¬é–‹URLç”¨ã‚¹ãƒ©ãƒƒã‚°
  status TEXT NOT NULL DEFAULT 'draft', -- 'draft', 'published', 'closed'

  -- å…¬é–‹è¨­å®š
  is_public BOOLEAN DEFAULT true,
  published_at TIMESTAMPTZ,
  closed_at TIMESTAMPTZ,

  -- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š
  theme JSONB DEFAULT '{"primaryColor": "#00B900", "backgroundColor": "#FFFFFF"}',
  submit_button_text TEXT DEFAULT 'é€ä¿¡ã™ã‚‹',

  -- å›ç­”å¾Œã®å‹•ä½œ
  after_submit JSONB DEFAULT '{}', -- afterSubmit interface

  -- åˆ¶é™è¨­å®š
  limits JSONB DEFAULT '{}', -- limits interface

  -- é€šçŸ¥è¨­å®š
  notifications JSONB DEFAULT '{}', -- notifications interface

  -- çµ±è¨ˆæƒ…å ±
  total_submissions INTEGER DEFAULT 0,

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_forms_org ON forms(organization_id);
CREATE INDEX idx_forms_channel ON forms(channel_id);
CREATE INDEX idx_forms_slug ON forms(slug);
CREATE INDEX idx_forms_status ON forms(status);

-- RLS
ALTER TABLE forms ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage forms in their organizations"
ON forms FOR ALL
USING (
  organization_id IN (
    SELECT organization_id
    FROM user_organizations
    WHERE user_id = auth.uid()
  )
);
```

#### Table 2: `form_fields` (ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©)

```sql
CREATE TABLE form_fields (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  form_id UUID NOT NULL REFERENCES forms(id) ON DELETE CASCADE,

  -- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åŸºæœ¬æƒ…å ±
  type TEXT NOT NULL, -- 'text', 'textarea', 'email', 'tel', 'number', 'date', 'time', 'radio', 'checkbox', 'select', 'file'
  label TEXT NOT NULL,
  placeholder TEXT,
  description TEXT,
  required BOOLEAN DEFAULT false,
  order_index INTEGER NOT NULL, -- è¡¨ç¤ºé †

  -- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
  validation JSONB DEFAULT '{}',

  -- é¸æŠè‚¢ï¼ˆradio, checkbox, selectç”¨ï¼‰
  options JSONB, -- [{value: "value1", label: "Label 1"}, ...]

  -- æ¡ä»¶åˆ†å²
  conditions JSONB, -- {showIf: [{fieldId: "xxx", operator: "equals", value: "value"}]}

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_form_fields_form ON form_fields(form_id);
CREATE INDEX idx_form_fields_order ON form_fields(form_id, order_index);

-- RLS
ALTER TABLE form_fields ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage form fields in their organizations"
ON form_fields FOR ALL
USING (
  form_id IN (
    SELECT id FROM forms
    WHERE organization_id IN (
      SELECT organization_id
      FROM user_organizations
      WHERE user_id = auth.uid()
    )
  )
);
```

#### Table 3: `form_responses` (ãƒ•ã‚©ãƒ¼ãƒ å›ç­”ãƒ‡ãƒ¼ã‚¿)

```sql
CREATE TABLE form_responses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  form_id UUID NOT NULL REFERENCES forms(id) ON DELETE CASCADE,
  friend_id UUID REFERENCES line_friends(id) ON DELETE SET NULL,

  -- å›ç­”ãƒ‡ãƒ¼ã‚¿
  response_data JSONB NOT NULL, -- {fieldId: value, fieldId: value, ...}

  -- é€ä¿¡è€…æƒ…å ±
  ip_address INET,
  user_agent TEXT,

  -- LIFFæƒ…å ±
  liff_context JSONB, -- LIFFçµŒç”±ã®å ´åˆã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±

  -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  submitted_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_form_responses_form ON form_responses(form_id);
CREATE INDEX idx_form_responses_friend ON form_responses(friend_id);
CREATE INDEX idx_form_responses_submitted ON form_responses(submitted_at DESC);

-- RLS
ALTER TABLE form_responses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view responses in their organizations"
ON form_responses FOR SELECT
USING (
  form_id IN (
    SELECT id FROM forms
    WHERE organization_id IN (
      SELECT organization_id
      FROM user_organizations
      WHERE user_id = auth.uid()
    )
  )
);

CREATE POLICY "Anyone can insert form responses"
ON form_responses FOR INSERT
WITH CHECK (true);
```

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”»é¢æ§‹æˆï¼ˆ4ç”»é¢ï¼‰

#### 1. `/dashboard/forms` - ãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§

**ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ**:
```
forms/
â”œâ”€â”€ page.tsx (ä¸€è¦§ç”»é¢)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ FormList.tsx (ãƒ•ã‚©ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ä¸€è¦§)
â”‚   â”œâ”€â”€ FormCard.tsx (å€‹åˆ¥ãƒ•ã‚©ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰)
â”‚   â”œâ”€â”€ FormFilters.tsx (ãƒ•ã‚£ãƒ«ã‚¿UI)
â”‚   â””â”€â”€ FormStats.tsx (çµ±è¨ˆã‚µãƒãƒªãƒ¼)
```

**è¡¨ç¤ºæƒ…å ±**:
- ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆä¸‹æ›¸ã/å…¬é–‹ä¸­/çµ‚äº†ï¼‰
- å›ç­”æ•°
- ä½œæˆæ—¥æ™‚
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç·¨é›†/å›ç­”é–²è¦§/è¤‡è£½/å‰Šé™¤ï¼‰

#### 2. `/dashboard/forms/new` - ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ

**ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ**:
```
forms/new/
â”œâ”€â”€ page.tsx (ãƒ¡ã‚¤ãƒ³ç”»é¢)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ FormBuilder.tsx (ãƒ“ãƒ«ãƒ€ãƒ¼ãƒ¡ã‚¤ãƒ³)
â”‚   â”œâ”€â”€ FieldPalette.tsx (ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸€è¦§ã‚µã‚¤ãƒ‰ãƒãƒ¼)
â”‚   â”œâ”€â”€ FieldEditor.tsx (ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­å®šãƒ‘ãƒãƒ«)
â”‚   â”œâ”€â”€ FormPreview.tsx (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼)
â”‚   â”œâ”€â”€ FormSettings.tsx (ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°)
â”‚   â””â”€â”€ fields/
â”‚       â”œâ”€â”€ TextField.tsx
â”‚       â”œâ”€â”€ EmailField.tsx
â”‚       â”œâ”€â”€ RadioField.tsx
â”‚       â””â”€â”€ ... (å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)
```

**ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header: ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ                       [ä¿å­˜][å…¬é–‹] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       â”‚                         â”‚                   â”‚
â”‚ Field â”‚   Form Builder Area     â”‚   Field Editor    â”‚
â”‚ Palet â”‚                         â”‚                   â”‚
â”‚       â”‚   (Drag & Drop)         â”‚   (Settings)      â”‚
â”‚       â”‚                         â”‚                   â”‚
â”‚       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚       â”‚   Preview               â”‚                   â”‚
â”‚       â”‚   (Real-time)           â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. `/dashboard/forms/[id]/edit` - ãƒ•ã‚©ãƒ¼ãƒ ç·¨é›†

**æ©Ÿèƒ½**: `/dashboard/forms/new` ã¨åŒã˜UIã€ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½è¿½åŠ 

#### 4. `/dashboard/forms/[id]/submissions` - å›ç­”ä¸€è¦§

**ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ**:
```
forms/[id]/submissions/
â”œâ”€â”€ page.tsx (å›ç­”ä¸€è¦§ç”»é¢)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ SubmissionTable.tsx (å›ç­”ãƒ†ãƒ¼ãƒ–ãƒ«)
â”‚   â”œâ”€â”€ SubmissionFilters.tsx (ãƒ•ã‚£ãƒ«ã‚¿)
â”‚   â”œâ”€â”€ SubmissionDetail.tsx (è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«)
â”‚   â”œâ”€â”€ ExportDialog.tsx (ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š)
â”‚   â””â”€â”€ BulkActions.tsx (ä¸€æ‹¬æ“ä½œ)
```

**è¡¨ç¤ºæƒ…å ±**:
- é€ä¿¡æ—¥æ™‚
- å‹ã ã¡åï¼ˆLINEè¡¨ç¤ºåï¼‰
- å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å›ç­”å†…å®¹ï¼ˆã‚«ãƒ©ãƒ åŒ–ï¼‰
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè©³ç´°/å‰Šé™¤ï¼‰

#### 5. `/f/[slug]` - å…¬é–‹ãƒ•ã‚©ãƒ¼ãƒ ãƒšãƒ¼ã‚¸

**ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ**:
```
(public)/
â”œâ”€â”€ f/
â”‚   â””â”€â”€ [slug]/
â”‚       â”œâ”€â”€ page.tsx (å…¬é–‹ãƒ•ã‚©ãƒ¼ãƒ )
â”‚       â””â”€â”€ components/
â”‚           â”œâ”€â”€ PublicFormLayout.tsx
â”‚           â”œâ”€â”€ FormField.tsx (ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æç”»)
â”‚           â”œâ”€â”€ SubmitButton.tsx
â”‚           â””â”€â”€ ThankYouMessage.tsx
```

**ç‰¹å¾´**:
- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
- LIFFé€£æºï¼ˆLINEå†…ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒ ã®å ´åˆï¼‰

---

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‡¦ç†ãƒ•ãƒ­ãƒ¼

#### 1. ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ•ãƒ­ãƒ¼

```typescript
// POST /api/forms

1. ãƒ•ã‚©ãƒ¼ãƒ åŸºæœ¬æƒ…å ±ã‚’formsãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¿å…¥
2. ã‚¹ãƒ©ãƒƒã‚°ç”Ÿæˆï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒã‚§ãƒƒã‚¯ï¼‰
3. ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’form_fieldsãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¸€æ‹¬æŒ¿å…¥
4. å…¬é–‹URLç”Ÿæˆ
5. ãƒ•ã‚©ãƒ¼ãƒ IDã‚’è¿”å´
```

#### 2. ãƒ•ã‚©ãƒ¼ãƒ å›ç­”é€ä¿¡ãƒ•ãƒ­ãƒ¼

```typescript
// POST /api/forms/[slug]/submit

1. ã‚¹ãƒ©ãƒƒã‚°ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ å–å¾—
2. ãƒ•ã‚©ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªï¼ˆpublished ã‹ãƒã‚§ãƒƒã‚¯ï¼‰
3. å›ç­”ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   - å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
   - ãƒ‡ãƒ¼ã‚¿å‹ãƒã‚§ãƒƒã‚¯
   - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«é©ç”¨
4. LIFFçµŒç”±ã®å ´åˆã€LINEå‹ã ã¡æƒ…å ±å–å¾—
5. form_responsesãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¿å…¥
6. forms.total_submissions ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
7. è‡ªå‹•å¿œç­”å‡¦ç†ï¼ˆEdge Functionå‘¼ã³å‡ºã—ï¼‰
   - ã‚µãƒ³ã‚¯ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
   - ã‚¿ã‚°è‡ªå‹•ä»˜ä¸
   - ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡ãƒˆãƒªã‚¬ãƒ¼
8. é€šçŸ¥å‡¦ç†ï¼ˆãƒ¡ãƒ¼ãƒ«/LINE Notifyï¼‰
9. é€ä¿¡å®Œäº†ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```

#### 3. å›ç­”ä¸€è¦§å–å¾—ãƒ•ãƒ­ãƒ¼

```typescript
// GET /api/forms/[id]/submissions

1. ãƒ•ã‚©ãƒ¼ãƒ IDæ¤œè¨¼ï¼ˆRLSè‡ªå‹•é©ç”¨ï¼‰
2. ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ
   - page, limit (ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³)
   - sort, order (ã‚½ãƒ¼ãƒˆ)
   - filters (ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶)
3. form_responsesãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
4. JOIN line_friends ã§å‹ã ã¡æƒ…å ±ä»˜ä¸
5. ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢
```

---

### Edge Functionsï¼ˆ2é–¢æ•°ï¼‰

#### 1. `process-form-submission`

**å½¹å‰²**: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å¾Œã®è‡ªå‹•å‡¦ç†

**ãƒˆãƒªã‚¬ãƒ¼**: Database Triggerï¼ˆform_responses INSERTå¾Œï¼‰

**å‡¦ç†å†…å®¹**:
```typescript
export async function processFormSubmission(payload: FormSubmissionPayload) {
  const { formId, responseId, friendId } = payload

  // 1. ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šå–å¾—
  const form = await supabase.from('forms').select('*').eq('id', formId).single()

  // 2. ã‚µãƒ³ã‚¯ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  if (form.after_submit.sendLineMessage?.enabled && friendId) {
    await sendLineMessage({
      to: friendId,
      messageId: form.after_submit.sendLineMessage.messageId
    })
  }

  // 3. ã‚¿ã‚°è‡ªå‹•ä»˜ä¸
  if (form.after_submit.addTags?.length && friendId) {
    await addTagsToFriend(friendId, form.after_submit.addTags)
  }

  // 4. é€šçŸ¥é€ä¿¡
  if (form.notifications.enabled) {
    await sendNotifications(form, responseId)
  }

  // 5. ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡ãƒˆãƒªã‚¬ãƒ¼ï¼ˆä»Šå¾Œå®Ÿè£…ï¼‰
  // await triggerStepCampaign(friendId, formId)
}
```

#### 2. `export-form-responses`

**å½¹å‰²**: ãƒ•ã‚©ãƒ¼ãƒ å›ç­”ã®CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

**ãƒˆãƒªã‚¬ãƒ¼**: HTTP Requestï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œï¼‰

**å‡¦ç†å†…å®¹**:
```typescript
export async function exportFormResponses(request: Request) {
  const { formId, filters, fields } = await request.json()

  // 1. ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ï¼‰
  const responses = await fetchResponses(formId, filters)

  // 2. CSVå¤‰æ›
  const csv = convertToCSV(responses, fields)

  // 3. Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const fileName = `form_${formId}_${Date.now()}.csv`
  const { data } = await supabase.storage
    .from('exports')
    .upload(fileName, csv)

  // 4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLç”Ÿæˆï¼ˆ1æ™‚é–“æœ‰åŠ¹ï¼‰
  const { data: { signedUrl } } = await supabase.storage
    .from('exports')
    .createSignedUrl(fileName, 3600)

  return { url: signedUrl }
}
```

---

## ğŸ¨ UI/UXè¨­è¨ˆ

### ãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ€ãƒ¼ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³

#### ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å®Ÿè£…

**ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: `@dnd-kit/core` + `@dnd-kit/sortable`

```typescript
import { DndContext, closestCenter } from '@dnd-kit/core'
import { SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable'

function FormBuilder() {
  const [fields, setFields] = useState<FormField[]>([])

  const handleDragEnd = (event) => {
    const { active, over } = event

    if (active.id !== over.id) {
      const oldIndex = fields.findIndex(f => f.id === active.id)
      const newIndex = fields.findIndex(f => f.id === over.id)

      setFields(arrayMove(fields, oldIndex, newIndex))
    }
  }

  return (
    <DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
      <SortableContext items={fields} strategy={verticalListSortingStrategy}>
        {fields.map(field => (
          <SortableField key={field.id} field={field} />
        ))}
      </SortableContext>
    </DndContext>
  )
}
```

#### ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

**å®Ÿè£…**: ãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ€ãƒ¼ã®å¤‰æ›´ã‚’å³åº§ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«åæ˜ 

```typescript
const [formData, setFormData] = useState<Form>({...})
const [fields, setFields] = useState<FormField[]>([])

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
function FormPreview({ form, fields }) {
  return (
    <div style={{ backgroundColor: form.theme.backgroundColor }}>
      <h2>{form.title}</h2>
      <p>{form.description}</p>

      {fields.map(field => (
        <FormFieldPreview key={field.id} field={field} />
      ))}

      <Button style={{ backgroundColor: form.theme.primaryColor }}>
        {form.submitButtonText}
      </Button>
    </div>
  )
}
```

---

### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­å®šãƒ‘ãƒãƒ«ã®UI

**shadcn/ui Components**:
- `Input` - ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
- `Textarea` - èª¬æ˜æ–‡å…¥åŠ›
- `Switch` - å¿…é ˆé …ç›®ãƒˆã‚°ãƒ«
- `Select` - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—é¸æŠ
- `Accordion` - è©³ç´°è¨­å®šã®æŠ˜ã‚ŠãŸãŸã¿
- `Tabs` - åŸºæœ¬è¨­å®š/ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³/æ¡ä»¶åˆ†å²ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ

**ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¾‹**:
```tsx
<div className="w-80 border-l bg-white p-6">
  <h3>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­å®š</h3>

  <Tabs defaultValue="basic">
    <TabsList>
      <TabsTrigger value="basic">åŸºæœ¬</TabsTrigger>
      <TabsTrigger value="validation">æ¤œè¨¼</TabsTrigger>
      <TabsTrigger value="conditions">æ¡ä»¶</TabsTrigger>
    </TabsList>

    <TabsContent value="basic">
      <Label>ãƒ©ãƒ™ãƒ«</Label>
      <Input value={field.label} onChange={...} />

      <Label>ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼</Label>
      <Input value={field.placeholder} onChange={...} />

      <div className="flex items-center gap-2">
        <Switch checked={field.required} onCheckedChange={...} />
        <Label>å¿…é ˆé …ç›®</Label>
      </div>
    </TabsContent>

    <TabsContent value="validation">
      {/* ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šUI */}
    </TabsContent>

    <TabsContent value="conditions">
      {/* æ¡ä»¶åˆ†å²è¨­å®šUI */}
    </TabsContent>
  </Tabs>
</div>
```

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 1. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

**CSRFå¯¾ç­–**:
- Next.js Server Actionsã‚’ä½¿ç”¨ï¼ˆè‡ªå‹•çš„ã«CSRFä¿è­·ï¼‰
- å…¬é–‹ãƒ•ã‚©ãƒ¼ãƒ ã«ã¯ç‹¬è‡ªã®ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼

**Rate Limiting**:
```typescript
// Edge Functionã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…
const rateLimit = {
  windowMs: 15 * 60 * 1000, // 15åˆ†
  maxRequests: 5, // æœ€å¤§5å›
}

// IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ™ãƒ¼ã‚¹ã®åˆ¶é™
if (await isRateLimited(ipAddress)) {
  return new Response('Too Many Requests', { status: 429 })
}
```

**ã‚¹ãƒ‘ãƒ å¯¾ç­–**:
- reCAPTCHA v3çµ±åˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- ãƒãƒ‹ãƒ¼ãƒãƒƒãƒˆï¼ˆéš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
- é€ä¿¡é–“éš”ãƒã‚§ãƒƒã‚¯

### 2. ãƒ‡ãƒ¼ã‚¿ä¿è­·

**å€‹äººæƒ…å ±ã®æš—å·åŒ–**:
```sql
-- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€é›»è©±ç•ªå·ãªã©æ©Ÿå¯†æƒ…å ±ã‚’æš—å·åŒ–
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- æš—å·åŒ–ã—ã¦ä¿å­˜
UPDATE form_responses
SET response_data = jsonb_set(
  response_data,
  '{email}',
  to_jsonb(pgp_sym_encrypt(email_value, 'encryption_key'))
);
```

**RLSï¼ˆRow Level Securityï¼‰**:
- ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«RLSé©ç”¨æ¸ˆã¿
- çµ„ç¹”IDãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- å…¬é–‹ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã¯INSERTã®ã¿è¨±å¯

---

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ€ãƒ¼ã®æœ€é©åŒ–

**ä»®æƒ³åŒ–ãƒªã‚¹ãƒˆ**:
```typescript
import { useVirtualizer } from '@tanstack/react-virtual'

// ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒ50å€‹ä»¥ä¸Šã®å ´åˆã«ä»®æƒ³åŒ–
function FieldList({ fields }) {
  const parentRef = useRef(null)

  const virtualizer = useVirtualizer({
    count: fields.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 100,
  })

  return (
    <div ref={parentRef} className="h-[600px] overflow-auto">
      {virtualizer.getVirtualItems().map((virtualItem) => (
        <FieldRow key={virtualItem.key} field={fields[virtualItem.index]} />
      ))}
    </div>
  )
}
```

### 2. å›ç­”ä¸€è¦§ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

**ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³**:
```typescript
// GET /api/forms/[id]/submissions?page=1&limit=50

const { data, count } = await supabase
  .from('form_responses')
  .select('*, line_friends(display_name, picture_url)', { count: 'exact' })
  .eq('form_id', formId)
  .range((page - 1) * limit, page * limit - 1)
  .order('submitted_at', { ascending: false })

return {
  data,
  pagination: {
    total: count,
    page,
    limit,
    totalPages: Math.ceil(count / limit)
  }
}
```

### 3. CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®éåŒæœŸå‡¦ç†

**ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ–**:
```typescript
// å¤§é‡ãƒ‡ãƒ¼ã‚¿ï¼ˆ1000ä»¶ä»¥ä¸Šï¼‰ã®å ´åˆã€éåŒæœŸå‡¦ç†
if (totalRecords > 1000) {
  // ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
  await queueExportJob({
    formId,
    userId,
    filters,
    email: user.email
  })

  return { message: 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚å®Œäº†å¾Œãƒ¡ãƒ¼ãƒ«ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚' }
} else {
  // å³åº§ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
  const csv = await generateCSV(formId, filters)
  return { url: csv.downloadUrl }
}
```

---

## âœ… å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆ2é€±é–“ï¼‰

### Week 1: ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ©Ÿèƒ½

#### Day 1-2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰
- [ ] `forms` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `form_fields` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `form_responses` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] RLSãƒãƒªã‚·ãƒ¼è¨­å®š
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
- [ ] Supabaseå‹å®šç¾©ç”Ÿæˆï¼ˆ`supabase gen types typescript`ï¼‰

#### Day 3-4: ãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ€ãƒ¼UI
- [ ] ãƒ•ã‚©ãƒ¼ãƒ ä¸€è¦§ç”»é¢å®Ÿè£…ï¼ˆ`/dashboard/forms`ï¼‰
- [ ] ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆ`/dashboard/forms/new`ï¼‰
- [ ] FieldPaletteï¼ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸€è¦§ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰å®Ÿè£…
- [ ] DnDæ©Ÿèƒ½å®Ÿè£…ï¼ˆ@dnd-kit/coreï¼‰
- [ ] ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ãƒ»å‰Šé™¤æ©Ÿèƒ½

#### Day 5: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—å®Ÿè£…ï¼ˆPart 1ï¼‰
- [ ] TextFieldï¼ˆ1è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
- [ ] TextareaFieldï¼ˆè¤‡æ•°è¡Œãƒ†ã‚­ã‚¹ãƒˆï¼‰
- [ ] EmailFieldï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
- [ ] TelFieldï¼ˆé›»è©±ç•ªå·ï¼‰
- [ ] NumberFieldï¼ˆæ•°å€¤ï¼‰

### Week 2: å›ç­”ç®¡ç†ãƒ»å…¬é–‹æ©Ÿèƒ½

#### Day 6: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—å®Ÿè£…ï¼ˆPart 2ï¼‰
- [ ] DateFieldï¼ˆæ—¥ä»˜ï¼‰
- [ ] TimeFieldï¼ˆæ™‚åˆ»ï¼‰
- [ ] RadioFieldï¼ˆå˜ä¸€é¸æŠï¼‰
- [ ] CheckboxFieldï¼ˆè¤‡æ•°é¸æŠï¼‰
- [ ] SelectFieldï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼‰
- [ ] FileUploadFieldï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰

#### Day 7: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­å®šãƒ‘ãƒãƒ«
- [ ] FieldEditorå®Ÿè£…ï¼ˆå³ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰
- [ ] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šUI
- [ ] æ¡ä»¶åˆ†å²è¨­å®šUIï¼ˆåŸºæœ¬ï¼‰
- [ ] ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆãƒ©ã‚¸ã‚ªãƒ»ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç”¨ï¼‰

#### Day 8: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ä¿å­˜æ©Ÿèƒ½
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè£…
- [ ] ãƒ•ã‚©ãƒ¼ãƒ ä¿å­˜APIï¼ˆPOST /api/formsï¼‰
- [ ] ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°APIï¼ˆPATCH /api/forms/[id]ï¼‰
- [ ] ã‚¹ãƒ©ãƒƒã‚°ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
- [ ] å…¬é–‹URLç”Ÿæˆ

#### Day 9: å…¬é–‹ãƒ•ã‚©ãƒ¼ãƒ ãƒšãƒ¼ã‚¸
- [ ] å…¬é–‹ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢å®Ÿè£…ï¼ˆ`/f/[slug]`ï¼‰
- [ ] ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡APIï¼ˆPOST /api/forms/[slug]/submitï¼‰
- [ ] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
- [ ] ã‚µãƒ³ã‚¯ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### Day 10: å›ç­”ç®¡ç†æ©Ÿèƒ½
- [ ] å›ç­”ä¸€è¦§ç”»é¢å®Ÿè£…ï¼ˆ`/dashboard/forms/[id]/submissions`ï¼‰
- [ ] å›ç­”ãƒ‡ãƒ¼ã‚¿å–å¾—APIï¼ˆGET /api/forms/[id]/submissionsï¼‰
- [ ] ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
- [ ] å›ç­”è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
- [ ] å›ç­”å‰Šé™¤æ©Ÿèƒ½

#### Day 11: CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- [ ] CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½å®Ÿè£…
- [ ] ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°
- [ ] Edge Function: `export-form-responses`
- [ ] Supabase Storageè¨­å®šï¼ˆexportsãƒã‚±ãƒƒãƒˆï¼‰

#### Day 12: è‡ªå‹•å¿œç­”é€£æº
- [ ] Edge Function: `process-form-submission`
- [ ] ã‚µãƒ³ã‚¯ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ©Ÿèƒ½
- [ ] ã‚¿ã‚°è‡ªå‹•ä»˜ä¸æ©Ÿèƒ½
- [ ] é€šçŸ¥æ©Ÿèƒ½ï¼ˆãƒ¡ãƒ¼ãƒ«/LINE Notifyï¼‰

#### Day 13: LIFFé€£æº
- [ ] LIFFè¨­å®šï¼ˆLINE Developersï¼‰
- [ ] LIFF SDKçµ±åˆ
- [ ] LINEå‹ã ã¡æƒ…å ±å–å¾—æ©Ÿèƒ½
- [ ] LIFFçµŒç”±ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒ†ã‚¹ãƒˆ

#### Day 14: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°
- [ ] ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ
- [ ] å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ã®å‹•ä½œç¢ºèª
- [ ] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
- [ ] å›ç­”é€ä¿¡ãƒ†ã‚¹ãƒˆ
- [ ] CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
- [ ] è‡ªå‹•å¿œç­”ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] ãƒã‚°ãƒ•ã‚£ãƒƒã‚¯ã‚¹

---

## ğŸš€ å®Ÿè£…é †åºã®æ¨å¥¨ãƒ•ãƒ­ãƒ¼

### å„ªå…ˆé †ä½ä»˜ã‘

**Phase 3-1: åŸºæœ¬æ©Ÿèƒ½ï¼ˆå¿…é ˆï¼‰**
1. ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ï¼‰
2. ãƒ•ã‚©ãƒ¼ãƒ ä¿å­˜ãƒ»å…¬é–‹
3. å…¬é–‹ãƒ•ã‚©ãƒ¼ãƒ ãƒšãƒ¼ã‚¸
4. å›ç­”é€ä¿¡ãƒ»ä¿å­˜
5. å›ç­”ä¸€è¦§è¡¨ç¤º

**Phase 3-2: æ‹¡å¼µæ©Ÿèƒ½ï¼ˆé‡è¦ï¼‰**
6. å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—å®Ÿè£…
7. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
8. CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
9. å›ç­”è©³ç´°ãƒ»å‰Šé™¤

**Phase 3-3: é«˜åº¦ãªæ©Ÿèƒ½ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰**
10. æ¡ä»¶åˆ†å²æ©Ÿèƒ½
11. LIFFé€£æº
12. è‡ªå‹•å¿œç­”é€£æº
13. A/Bãƒ†ã‚¹ãƒˆæ©Ÿèƒ½

---

## ğŸ“ ã‚³ãƒ¼ãƒ‰å®Ÿè£…ä¾‹

### 1. ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆAPIï¼ˆServer Actionï¼‰

```typescript
// app/dashboard/forms/actions.ts
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'

export async function createForm(formData: {
  title: string
  description?: string
  fields: FormField[]
}) {
  const supabase = await createClient()

  // 1. ã‚¹ãƒ©ãƒƒã‚°ç”Ÿæˆ
  const slug = generateSlug(formData.title)

  // 2. ãƒ•ã‚©ãƒ¼ãƒ æŒ¿å…¥
  const { data: form, error: formError } = await supabase
    .from('forms')
    .insert({
      title: formData.title,
      description: formData.description,
      slug,
      status: 'draft',
    })
    .select()
    .single()

  if (formError) throw formError

  // 3. ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸€æ‹¬æŒ¿å…¥
  const fieldsToInsert = formData.fields.map((field, index) => ({
    form_id: form.id,
    ...field,
    order_index: index,
  }))

  const { error: fieldsError } = await supabase
    .from('form_fields')
    .insert(fieldsToInsert)

  if (fieldsError) throw fieldsError

  revalidatePath('/dashboard/forms')

  return { formId: form.id, slug: form.slug }
}

function generateSlug(title: string): string {
  const base = title
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-|-$/g, '')

  const randomSuffix = Math.random().toString(36).substring(2, 8)
  return `${base}-${randomSuffix}`
}
```

### 2. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡APIï¼ˆPublic Endpointï¼‰

```typescript
// app/api/forms/[slug]/submit/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'

export async function POST(
  request: NextRequest,
  { params }: { params: { slug: string } }
) {
  const supabase = await createClient()
  const { slug } = params
  const body = await request.json()

  // 1. ãƒ•ã‚©ãƒ¼ãƒ å–å¾—
  const { data: form, error: formError } = await supabase
    .from('forms')
    .select('*, form_fields(*)')
    .eq('slug', slug)
    .single()

  if (formError || form.status !== 'published') {
    return NextResponse.json({ error: 'Form not found or not published' }, { status: 404 })
  }

  // 2. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const validationErrors = validateFormData(form.form_fields, body.responseData)
  if (validationErrors.length > 0) {
    return NextResponse.json({ errors: validationErrors }, { status: 400 })
  }

  // 3. å›ç­”ä¿å­˜
  const { data: response, error: responseError } = await supabase
    .from('form_responses')
    .insert({
      form_id: form.id,
      friend_id: body.friendId || null,
      response_data: body.responseData,
      ip_address: request.ip,
      user_agent: request.headers.get('user-agent'),
    })
    .select()
    .single()

  if (responseError) {
    return NextResponse.json({ error: 'Failed to save response' }, { status: 500 })
  }

  // 4. å›ç­”æ•°ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
  await supabase
    .from('forms')
    .update({ total_submissions: form.total_submissions + 1 })
    .eq('id', form.id)

  // 5. Edge Functionå‘¼ã³å‡ºã—ï¼ˆè‡ªå‹•å¿œç­”å‡¦ç†ï¼‰
  await fetch(`${process.env.SUPABASE_URL}/functions/v1/process-form-submission`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${process.env.SUPABASE_ANON_KEY}`,
    },
    body: JSON.stringify({
      formId: form.id,
      responseId: response.id,
      friendId: body.friendId,
    }),
  })

  return NextResponse.json({ success: true, responseId: response.id })
}

function validateFormData(fields: FormField[], data: Record<string, any>): string[] {
  const errors: string[] = []

  fields.forEach(field => {
    const value = data[field.id]

    // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
    if (field.required && !value) {
      errors.push(`${field.label}ã¯å¿…é ˆé …ç›®ã§ã™`)
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«é©ç”¨
    if (field.validation) {
      if (field.validation.minLength && value.length < field.validation.minLength) {
        errors.push(`${field.label}ã¯${field.validation.minLength}æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„`)
      }

      if (field.validation.maxLength && value.length > field.validation.maxLength) {
        errors.push(`${field.label}ã¯${field.validation.maxLength}æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„`)
      }

      if (field.validation.pattern) {
        const regex = new RegExp(field.validation.pattern)
        if (!regex.test(value)) {
          errors.push(`${field.label}ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“`)
        }
      }
    }
  })

  return errors
}
```

### 3. ãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ€ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// app/dashboard/forms/new/components/FormBuilder.tsx
'use client'

import { useState } from 'react'
import { DndContext, closestCenter, DragEndEvent } from '@dnd-kit/core'
import { SortableContext, verticalListSortingStrategy, arrayMove } from '@dnd-kit/sortable'
import { FieldPalette } from './FieldPalette'
import { SortableField } from './SortableField'
import { FieldEditor } from './FieldEditor'
import { FormPreview } from './FormPreview'
import { Button } from '@/components/ui/button'
import { createForm } from '../actions'

export function FormBuilder() {
  const [form, setForm] = useState<Form>({
    title: 'æ–°è¦ãƒ•ã‚©ãƒ¼ãƒ ',
    description: '',
    theme: { primaryColor: '#00B900', backgroundColor: '#FFFFFF' },
    submitButtonText: 'é€ä¿¡ã™ã‚‹',
  })

  const [fields, setFields] = useState<FormField[]>([])
  const [selectedFieldId, setSelectedFieldId] = useState<string | null>(null)
  const [saving, setSaving] = useState(false)

  const handleAddField = (type: FieldType) => {
    const newField: FormField = {
      id: `field_${Date.now()}`,
      type,
      label: `ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ ${fields.length + 1}`,
      required: false,
      order: fields.length,
    }

    setFields([...fields, newField])
    setSelectedFieldId(newField.id)
  }

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event

    if (over && active.id !== over.id) {
      setFields((items) => {
        const oldIndex = items.findIndex((i) => i.id === active.id)
        const newIndex = items.findIndex((i) => i.id === over.id)
        return arrayMove(items, oldIndex, newIndex)
      })
    }
  }

  const handleFieldUpdate = (fieldId: string, updates: Partial<FormField>) => {
    setFields(fields.map(f => f.id === fieldId ? { ...f, ...updates } : f))
  }

  const handleSave = async () => {
    setSaving(true)
    try {
      const result = await createForm({ ...form, fields })
      alert('ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ')
      // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†
    } catch (error) {
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ')
    } finally {
      setSaving(false)
    }
  }

  const selectedField = fields.find(f => f.id === selectedFieldId)

  return (
    <div className="flex h-screen">
      {/* å·¦: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ‘ãƒ¬ãƒƒãƒˆ */}
      <FieldPalette onAddField={handleAddField} />

      {/* ä¸­å¤®: ãƒ“ãƒ«ãƒ€ãƒ¼ */}
      <div className="flex-1 overflow-y-auto p-6">
        <div className="max-w-4xl mx-auto">
          <div className="mb-6 flex justify-between items-center">
            <input
              type="text"
              value={form.title}
              onChange={(e) => setForm({ ...form, title: e.target.value })}
              className="text-3xl font-bold border-none focus:outline-none"
            />
            <Button onClick={handleSave} disabled={saving}>
              {saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
            </Button>
          </div>

          <DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
            <SortableContext items={fields} strategy={verticalListSortingStrategy}>
              {fields.map(field => (
                <SortableField
                  key={field.id}
                  field={field}
                  isSelected={field.id === selectedFieldId}
                  onClick={() => setSelectedFieldId(field.id)}
                />
              ))}
            </SortableContext>
          </DndContext>

          {/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
          <div className="mt-8">
            <h3 className="text-xl font-bold mb-4">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            <FormPreview form={form} fields={fields} />
          </div>
        </div>
      </div>

      {/* å³: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­å®š */}
      {selectedField && (
        <FieldEditor
          field={selectedField}
          onUpdate={(updates) => handleFieldUpdate(selectedField.id, updates)}
          onClose={() => setSelectedFieldId(null)}
        />
      )}
    </div>
  )
}
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 1. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆå¯¾è±¡**:
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
- ã‚¹ãƒ©ãƒƒã‚°ç”Ÿæˆé–¢æ•°
- CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–¢æ•°

**ãƒ„ãƒ¼ãƒ«**: Jest + React Testing Library

```typescript
// __tests__/forms/validation.test.ts
import { validateFormData } from '@/lib/forms/validation'

describe('validateFormData', () => {
  it('should validate required fields', () => {
    const fields = [
      { id: '1', label: 'Name', required: true }
    ]
    const data = {}

    const errors = validateFormData(fields, data)
    expect(errors).toContain('Nameã¯å¿…é ˆé …ç›®ã§ã™')
  })

  it('should validate email format', () => {
    const fields = [
      { id: '1', label: 'Email', type: 'email', validation: { pattern: '^[^@]+@[^@]+\.[^@]+$' } }
    ]
    const data = { '1': 'invalid-email' }

    const errors = validateFormData(fields, data)
    expect(errors.length).toBeGreaterThan(0)
  })
})
```

### 2. çµ±åˆãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆå¯¾è±¡**:
- ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒ•ãƒ­ãƒ¼
- ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒ•ãƒ­ãƒ¼
- å›ç­”ãƒ‡ãƒ¼ã‚¿å–å¾—

**ãƒ„ãƒ¼ãƒ«**: Playwright

```typescript
// e2e/forms.spec.ts
import { test, expect } from '@playwright/test'

test('create and submit form', async ({ page }) => {
  // 1. ãƒ­ã‚°ã‚¤ãƒ³
  await page.goto('/login')
  await page.fill('[name=email]', 'test@example.com')
  await page.fill('[name=password]', 'password')
  await page.click('button[type=submit]')

  // 2. ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ
  await page.goto('/dashboard/forms/new')
  await page.fill('input[placeholder="ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ«"]', 'ãƒ†ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ãƒ ')

  // 3. ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
  await page.click('[data-field-type="text"]')
  await page.fill('[name="field-label"]', 'ãŠåå‰')

  // 4. ä¿å­˜
  await page.click('button:has-text("ä¿å­˜")')
  await expect(page).toHaveURL(/\/dashboard\/forms/)

  // 5. å…¬é–‹ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹
  const slug = await page.textContent('[data-form-slug]')
  await page.goto(`/f/${slug}`)

  // 6. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  await page.fill('[name="field_1"]', 'å±±ç”°å¤ªéƒ')
  await page.click('button[type=submit]')
  await expect(page.locator('text=é€ä¿¡å®Œäº†')).toBeVisible()
})
```

---

## ğŸ“ˆ æˆåŠŸæŒ‡æ¨™ï¼ˆKPIï¼‰

### é–‹ç™ºå®Œäº†ã®å®šç¾©

- [ ] 11ç¨®é¡ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ãŒå‹•ä½œã™ã‚‹
- [ ] ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆã‹ã‚‰é€ä¿¡ã¾ã§ã®ãƒ•ãƒ«ãƒ•ãƒ­ãƒ¼å®Œäº†
- [ ] CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹
- [ ] è‡ªå‹•å¿œç­”é€£æºï¼ˆã‚µãƒ³ã‚¯ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»ã‚¿ã‚°ä»˜ä¸ï¼‰ãŒå‹•ä½œã™ã‚‹
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆé€šéï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡1ç§’ä»¥å†…ï¼‰
- [ ] E2Eãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™å®Œäº†

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

- ãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ€ãƒ¼ã®åˆæœŸãƒ­ãƒ¼ãƒ‰: < 2ç§’
- ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒ¬ã‚¹ãƒãƒ³ã‚¹: < 1ç§’
- å›ç­”ä¸€è¦§ã®è¡¨ç¤º: < 1.5ç§’ï¼ˆ100ä»¶ï¼‰
- CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ: < 5ç§’ï¼ˆ1000ä»¶ï¼‰

---

## ğŸ”„ Phase 4ã¸ã®å¼•ãç¶™ãäº‹é …

### Phase 4ã§å®Ÿè£…äºˆå®šã®é–¢é€£æ©Ÿèƒ½

1. **ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼é€£æº**: ãƒ•ã‚©ãƒ¼ãƒ URLã‚’ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«è¨­å®š
2. **ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡é€£æº**: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡é–‹å§‹
3. **äºˆç´„ç®¡ç†é€£æº**: ãƒ•ã‚©ãƒ¼ãƒ å›ç­”ã‹ã‚‰äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ä½œæˆ
4. **ã‚¯ãƒ­ã‚¹åˆ†æ**: ãƒ•ã‚©ãƒ¼ãƒ å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æè»¸ã«è¿½åŠ 

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ‹¡å¼µã®ä½™åœ°

- `form_fields` ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ å¯èƒ½
- `form_responses.response_data` ã¯JSONBãªã®ã§æŸ”è»Ÿã«æ‹¡å¼µå¯èƒ½
- å°†æ¥çš„ã« `form_pages` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã—ã¦è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œ

---

## ğŸ“š å‚è€ƒãƒªã‚½ãƒ¼ã‚¹

### æŠ€è¡“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Next.js 15 Documentation](https://nextjs.org/docs)
- [Supabase Database Functions](https://supabase.com/docs/guides/database/functions)
- [dnd-kit Documentation](https://docs.dndkit.com/)
- [shadcn/ui Components](https://ui.shadcn.com/)
- [LINE Messaging API](https://developers.line.biz/ja/docs/messaging-api/)
- [LIFF Documentation](https://developers.line.biz/ja/docs/liff/)

### é¡ä¼¼è£½å“ã®å‚è€ƒ

- Typeform: https://www.typeform.com/
- Google Forms: https://www.google.com/forms/about/
- Jotform: https://www.jotform.com/
- ã‚¨ãƒ«ãƒ¡ãƒ•ã‚©ãƒ¼ãƒ æ©Ÿèƒ½: ï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«åˆ†ææ¸ˆã¿ï¼‰

---

## ğŸ“ å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹

### å®Ÿè£…å‰ã«å­¦ç¿’ã™ã¹ãå†…å®¹

1. **ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—**: dnd-kitåŸºç¤
2. **ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: React Hook Form + Zod
3. **JSONBã‚¯ã‚¨ãƒª**: PostgreSQLã®JSONBæ“ä½œ
4. **Edge Functions**: Supabase Functionsã®åŸºç¤
5. **LIFF**: LINE Front-end Frameworkã®åŸºæœ¬

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆãƒ»è³ªå•

Phase 3å®Ÿè£…ä¸­ã«ç–‘å•ç‚¹ãŒã‚ã‚Œã°ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

1. **ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: ã¾ãšå…¨ä½“ã‚’å†èª­
2. **å…ƒã®è¦ä»¶å®šç¾©**: `/claudedocs/REQUIREMENTS_V2.md`
3. **æ©Ÿèƒ½ä¸€è¦§**: `/claudedocs/lme_saas_features_complete.md` Line 115-136
4. **å®Ÿè£…TODO**: `/claudedocs/implementation_todo_v2.md` Line 708-712

---

**ä½œæˆè€…**: Claude (Anthropic)
**æœ€çµ‚æ›´æ–°**: 2025-10-29
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Ready for Implementation

---

**Next Steps**: Phase 3å®Ÿè£…é–‹å§‹ â†’ Day 1ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰ã€ã‹ã‚‰ç€æ‰‹
