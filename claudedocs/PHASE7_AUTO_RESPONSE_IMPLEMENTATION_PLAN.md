# Phase 7: è‡ªå‹•å¿œç­”æ©Ÿèƒ½ å®Œå…¨å®Ÿè£…è¨ˆç”»æ›¸

**ä½œæˆæ—¥**: 2025-10-30
**å¯¾è±¡ãƒ•ã‚§ãƒ¼ã‚º**: Phase 7
**æ‰€è¦æœŸé–“**: 5-7æ—¥
**å‰ææ¡ä»¶**: Phase 1-6å®Œäº†ï¼ˆå‹ã ã¡ç®¡ç†ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡ã€ã‚¿ã‚°ç®¡ç†ãŒå®Ÿè£…æ¸ˆã¿ï¼‰

---

## ç›®æ¬¡

1. [æ¦‚è¦](#1-æ¦‚è¦)
2. [æ©Ÿèƒ½ä»•æ§˜](#2-æ©Ÿèƒ½ä»•æ§˜)
3. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#3-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
4. [ç”»é¢è¨­è¨ˆ](#4-ç”»é¢è¨­è¨ˆ)
5. [å¿œç­”ãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆ](#5-å¿œç­”ãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆ)
6. [APIè¨­è¨ˆ](#6-apiè¨­è¨ˆ)
7. [Edge Functionsè¨­è¨ˆ](#7-edge-functionsè¨­è¨ˆ)
8. [AIçµ±åˆè¨­è¨ˆ](#8-aiçµ±åˆè¨­è¨ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³)
9. [å®Ÿè£…æ‰‹é †](#9-å®Ÿè£…æ‰‹é †)
10. [ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª](#10-ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª)

---

## 1. æ¦‚è¦

### 1.1 æ©Ÿèƒ½èª¬æ˜

è‡ªå‹•å¿œç­”æ©Ÿèƒ½ã¯ã€LINEå‹ã ã¡ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸéš›ã«ã€è¨­å®šã—ãŸãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦è‡ªå‹•çš„ã«å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ä¿¡ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°ã€ä¼šè©±ã‚·ãƒŠãƒªã‚ªã€æ¡ä»¶åˆ†å²ã€AIå¿œç­”ãªã©ã€è¤‡æ•°ã®å¿œç­”ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

### 1.2 ä¸»è¦æ©Ÿèƒ½

#### 1.2.1 ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¿œç­”
- **å®Œå…¨ä¸€è‡´**: å…¥åŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨å®Œå…¨ã«ä¸€è‡´ã—ãŸå ´åˆã«å¿œç­”
- **éƒ¨åˆ†ä¸€è‡´**: å…¥åŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹å ´åˆã«å¿œç­”
- **æ­£è¦è¡¨ç¾**: æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒãƒƒãƒãƒ³ã‚°ã—ãŸå ´åˆã«å¿œç­”
- **é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**: ç‰¹å®šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯å¿œç­”ã—ãªã„
- **å„ªå…ˆé †ä½**: è¤‡æ•°ãƒ«ãƒ¼ãƒ«ãŒãƒãƒƒãƒã—ãŸå ´åˆã®å„ªå…ˆåº¦åˆ¶å¾¡

#### 1.2.2 ã‚·ãƒŠãƒªã‚ªå¿œç­”ï¼ˆä¼šè©±ãƒ•ãƒ­ãƒ¼ï¼‰
- **ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†**: è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®ä¼šè©±ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰
- **åˆ†å²æ¡ä»¶**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ç­”ã«åŸºã¥ãåˆ†å²å‡¦ç†
- **çŠ¶æ…‹ç®¡ç†**: ä¼šè©±çŠ¶æ…‹ã®ä¿æŒï¼ˆé€²è¡Œä¸­ã€å®Œäº†ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: ä¸€å®šæ™‚é–“çµŒéå¾Œã®ä¼šè©±ãƒªã‚»ãƒƒãƒˆ
- **ã‚¹ãƒ†ãƒƒãƒ—é–“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: å„ã‚¹ãƒ†ãƒƒãƒ—ã§ã®ã‚¿ã‚°ä»˜ä¸ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãªã©

#### 1.2.3 æ¡ä»¶åˆ†å²
- **å‹ã ã¡å±æ€§**: ã‚¿ã‚°ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚ˆã‚‹æ¡ä»¶åˆ†å²
- **æ™‚é–“æ¡ä»¶**: æ™‚é–“å¸¯ï¼ˆå–¶æ¥­æ™‚é–“å†…/å¤–ï¼‰ã€æ›œæ—¥ã€æœŸé–“ã«ã‚ˆã‚‹å‡ºã—åˆ†ã‘
- **è¡Œå‹•æ¡ä»¶**: éå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–‹å°ã€URL ã‚¯ãƒªãƒƒã‚¯ã€ãƒ•ã‚©ãƒ¼ãƒ å›ç­”å±¥æ­´
- **ã‚«ã‚¦ãƒ³ãƒˆæ¡ä»¶**: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡å›æ•°ã€ç‰¹å®šã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œå›æ•°

#### 1.2.4 å¿œç­”ã‚¿ã‚¤ãƒ—
- **ãƒ†ã‚­ã‚¹ãƒˆå¿œç­”**: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¿œç­”**: å¤‰æ•°ï¼ˆåå‰ã€æ—¥ä»˜ãªã©ï¼‰ã‚’å«ã‚€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- **ãƒªãƒƒãƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: Flex Messageã€ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ã€ç”»åƒä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ**: ã‚¿ã‚°ä»˜ä¸ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç§»å‹•ã€ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡é–‹å§‹

#### 1.2.5 AIå¿œç­”ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- **ChatGPTçµ±åˆ**: OpenAI APIé€£æº
- **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š**: ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†
- **ä¼šè©±å±¥æ­´**: éå»ã®ä¼šè©±ã‚’è€ƒæ…®ã—ãŸå¿œç­”ç”Ÿæˆ
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: AIå¤±æ•—æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿œç­”

### 1.3 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: Next.js 16 + React 19 + shadcn/ui + Heroicons
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: Supabase (PostgreSQL + Edge Functions)
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ **: Supabase Realtime (ä¼šè©±çŠ¶æ…‹ã®åŒæœŸ)
- **AIçµ±åˆ**: OpenAI API (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

---

## 2. æ©Ÿèƒ½ä»•æ§˜

### 2.1 ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¿œç­”ãƒ«ãƒ¼ãƒ«

#### 2.1.1 ãƒãƒƒãƒãƒ³ã‚°ã‚¿ã‚¤ãƒ—

```typescript
type MatchType =
  | 'exact'        // å®Œå…¨ä¸€è‡´: "ã“ã‚“ã«ã¡ã¯" === "ã“ã‚“ã«ã¡ã¯"
  | 'partial'      // éƒ¨åˆ†ä¸€è‡´: "ã“ã‚“ã«ã¡ã¯" ã« "ã“ã‚“" ãŒå«ã¾ã‚Œã‚‹
  | 'startsWith'   // å‰æ–¹ä¸€è‡´: "ã“ã‚“ã«ã¡ã¯" ã§å§‹ã¾ã‚‹
  | 'endsWith'     // å¾Œæ–¹ä¸€è‡´: "ã“ã‚“ã«ã¡ã¯" ã§çµ‚ã‚ã‚‹
  | 'regex'        // æ­£è¦è¡¨ç¾: /^ã“ã‚“ã«ã¡ã¯.*/
```

#### 2.1.2 ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¨­å®š

| é …ç›® | èª¬æ˜ | ä¾‹ |
|------|------|-----|
| **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰** | ãƒãƒƒãƒãƒ³ã‚°å¯¾è±¡ã®æ–‡å­—åˆ— | "äºˆç´„", "æ–™é‡‘", "å–¶æ¥­æ™‚é–“" |
| **ãƒãƒƒãƒã‚¿ã‚¤ãƒ—** | ãƒãƒƒãƒãƒ³ã‚°æ–¹å¼ | å®Œå…¨ä¸€è‡´ã€éƒ¨åˆ†ä¸€è‡´ã€æ­£è¦è¡¨ç¾ |
| **å¤§æ–‡å­—å°æ–‡å­—** | åŒºåˆ¥ã™ã‚‹ã‹ | åŒºåˆ¥ã—ãªã„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ |
| **é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰** | ã“ã‚ŒãŒå«ã¾ã‚Œã‚‹å ´åˆã¯é™¤å¤– | "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", "ä¸è¦" |
| **å„ªå…ˆåº¦** | 1-100ï¼ˆæ•°å­—ãŒå¤§ãã„ã»ã©å„ªå…ˆï¼‰ | 10 |

#### 2.1.3 å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨­å®š

| é …ç›® | èª¬æ˜ |
|------|------|
| **å¿œç­”ã‚¿ã‚¤ãƒ—** | ãƒ†ã‚­ã‚¹ãƒˆã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Flexã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
| **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹** | å®Ÿéš›ã®å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| **å¤‰æ•°** | {name}, {date}, {time} ãªã©ã®å‹•çš„å¤‰æ•° |
| **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³** | ã‚¿ã‚°ä»˜ä¸ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¿½åŠ ã€ã‚¹ãƒ†ãƒƒãƒ—é…ä¿¡é–‹å§‹ |

### 2.2 ã‚·ãƒŠãƒªã‚ªå¿œç­”ï¼ˆä¼šè©±ãƒ•ãƒ­ãƒ¼ï¼‰

#### 2.2.1 ã‚·ãƒŠãƒªã‚ªæ§‹é€ 

```typescript
interface Scenario {
  id: string
  name: string
  description: string
  trigger: ScenarioTrigger    // é–‹å§‹æ¡ä»¶
  steps: ScenarioStep[]       // ã‚¹ãƒ†ãƒƒãƒ—é…åˆ—
  timeout_minutes: number     // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆåˆ†ï¼‰
  status: 'active' | 'inactive'
}

interface ScenarioStep {
  id: string
  scenario_id: string
  step_number: number         // ã‚¹ãƒ†ãƒƒãƒ—é †åº
  message: MessageContent     // é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  expected_input: ExpectedInput  // æœŸå¾…ã™ã‚‹å…¥åŠ›
  branches: ScenarioBranch[]  // åˆ†å²æ¡ä»¶
  actions: StepAction[]       // ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œæ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  next_step_id: string | null // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆåˆ†å²ãªã—ã®å ´åˆï¼‰
}

interface ScenarioBranch {
  id: string
  condition: BranchCondition  // åˆ†å²æ¡ä»¶
  next_step_id: string        // é·ç§»å…ˆã‚¹ãƒ†ãƒƒãƒ—
  actions: StepAction[]       // åˆ†å²æ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
}
```

#### 2.2.2 ã‚·ãƒŠãƒªã‚ªä¾‹ï¼šäºˆç´„å—ä»˜ãƒ•ãƒ­ãƒ¼

```
[ã‚¹ãƒ†ãƒƒãƒ—1] ãƒˆãƒªã‚¬ãƒ¼: "äºˆç´„" ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "ã”äºˆç´„ã‚’æ‰¿ã‚Šã¾ã™ã€‚ãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„"
â†’ æœŸå¾…å…¥åŠ›: ãƒ†ã‚­ã‚¹ãƒˆï¼ˆåå‰ï¼‰

[ã‚¹ãƒ†ãƒƒãƒ—2] å‰ã‚¹ãƒ†ãƒƒãƒ—ã®å›ç­”ã‚’å–å¾—
â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "{name}æ§˜ã€ã”å¸Œæœ›ã®æ—¥æ™‚ã‚’æ•™ãˆã¦ãã ã•ã„ï¼ˆä¾‹: 12/25 14:00ï¼‰"
â†’ æœŸå¾…å…¥åŠ›: æ—¥æ™‚å½¢å¼

[ã‚¹ãƒ†ãƒƒãƒ—3] æ—¥æ™‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â†’ æœ‰åŠ¹ãªå ´åˆ: "äºˆç´„ã‚’ç¢ºå®šã—ã¾ã—ãŸ"
â†’ ç„¡åŠ¹ãªå ´åˆ: "æ—¥æ™‚ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ãã ã•ã„"ï¼ˆã‚¹ãƒ†ãƒƒãƒ—2ã«æˆ»ã‚‹ï¼‰

[å®Œäº†] ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
â†’ ã‚¿ã‚°ä»˜ä¸: "äºˆç´„å®Œäº†"
â†’ äºˆç´„ãƒ‡ãƒ¼ã‚¿ä¿å­˜
â†’ ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¨­å®š
```

### 2.3 æ¡ä»¶åˆ†å²

#### 2.3.1 å‹ã ã¡å±æ€§æ¡ä»¶

```typescript
interface FriendAttributeCondition {
  type: 'tag' | 'segment' | 'custom_field'
  operator: 'has' | 'not_has' | 'equals' | 'not_equals' | 'contains'
  value: string | string[]
}

// ä¾‹
{
  type: 'tag',
  operator: 'has',
  value: ['VIP', 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡']
}
```

#### 2.3.2 æ™‚é–“æ¡ä»¶

```typescript
interface TimeCondition {
  type: 'time_range' | 'day_of_week' | 'date_range'

  // æ™‚é–“å¸¯ï¼ˆä¾‹: å–¶æ¥­æ™‚é–“å†…ã®ã¿å¿œç­”ï¼‰
  time_range?: {
    start: string  // "09:00"
    end: string    // "18:00"
  }

  // æ›œæ—¥ï¼ˆä¾‹: å¹³æ—¥ã®ã¿ï¼‰
  day_of_week?: number[]  // [1,2,3,4,5] = æœˆ-é‡‘

  // æœŸé–“ï¼ˆä¾‹: ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æœŸé–“ä¸­ï¼‰
  date_range?: {
    start: string  // "2025-12-01"
    end: string    // "2025-12-31"
  }
}
```

#### 2.3.3 è¡Œå‹•æ¡ä»¶

```typescript
interface BehaviorCondition {
  type: 'message_opened' | 'url_clicked' | 'form_submitted' | 'action_count'

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–‹å°æ¡ä»¶
  message_opened?: {
    message_id: string
    within_days: number  // éå»Næ—¥ä»¥å†…
  }

  // URLã‚¯ãƒªãƒƒã‚¯æ¡ä»¶
  url_clicked?: {
    url_mapping_id: string
    min_clicks: number
  }

  // ãƒ•ã‚©ãƒ¼ãƒ å›ç­”æ¡ä»¶
  form_submitted?: {
    form_id: string
    answer_conditions: Record<string, any>
  }

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å›æ•°æ¡ä»¶
  action_count?: {
    action_type: string
    operator: '>=' | '<=' | '=' | '>' | '<'
    count: number
  }
}
```

### 2.4 å¿œç­”ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

#### 2.4.1 ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—

```typescript
type ResponseAction =
  | { type: 'send_message', message: MessageContent }
  | { type: 'add_tag', tag_ids: string[] }
  | { type: 'remove_tag', tag_ids: string[] }
  | { type: 'add_to_segment', segment_id: string }
  | { type: 'start_step_campaign', campaign_id: string }
  | { type: 'trigger_webhook', webhook_url: string, payload: any }
  | { type: 'update_custom_field', field_name: string, value: any }
```

### 2.5 AIå¿œç­”è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

#### 2.5.1 OpenAIçµ±åˆ

```typescript
interface AIResponseSettings {
  enabled: boolean
  model: 'gpt-4' | 'gpt-4-turbo' | 'gpt-3.5-turbo'
  system_prompt: string
  temperature: number  // 0.0 - 1.0
  max_tokens: number
  context_history_count: number  // éå»ä½•ä»¶ã®ä¼šè©±ã‚’å«ã‚ã‚‹ã‹
  fallback_message: string  // AIå¤±æ•—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  fallback_actions: ResponseAction[]
}
```

#### 2.5.2 ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```typescript
const systemPromptTemplate = `
ã‚ãªãŸã¯{business_name}ã®LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆæ‹…å½“ã§ã™ã€‚

ã€åŸºæœ¬æƒ…å ±ã€‘
- å–¶æ¥­æ™‚é–“: {business_hours}
- æä¾›ã‚µãƒ¼ãƒ“ã‚¹: {services}
- ã‚ˆãã‚ã‚‹è³ªå•: {faq}

ã€å¯¾å¿œæ–¹é‡ã€‘
- ä¸å¯§ã§è¦ªã—ã¿ã‚„ã™ã„å£èª¿ã§å¯¾å¿œã—ã¦ãã ã•ã„
- ä¸æ˜ãªç‚¹ã¯æ­£ç›´ã«ã€Œç¢ºèªã—ã¾ã™ã€ã¨ä¼ãˆã¦ãã ã•ã„
- å–¶æ¥­æ™‚é–“å¤–ã®å ´åˆã¯ç¿Œå–¶æ¥­æ—¥ã®å¯¾å¿œã‚’æ¡ˆå†…ã—ã¦ãã ã•ã„

ã€å‹ã ã¡æƒ…å ±ã€‘
- åå‰: {friend_name}
- ã‚¿ã‚°: {friend_tags}
- éå»ã®å±¥æ­´: {friend_history}
`
```

---

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 3.1 ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§

```sql
-- è‡ªå‹•å¿œç­”ãƒ«ãƒ¼ãƒ«ãƒã‚¹ã‚¿
CREATE TABLE auto_response_rules (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  type TEXT NOT NULL, -- 'keyword', 'scenario', 'ai'
  priority INTEGER DEFAULT 10, -- 1-100
  status TEXT DEFAULT 'active', -- 'active', 'inactive', 'draft'
  conditions JSONB DEFAULT '{}', -- æ™‚é–“æ¡ä»¶ã€å‹ã ã¡å±æ€§æ¡ä»¶ãªã©
  settings JSONB DEFAULT '{}', -- ãƒ«ãƒ¼ãƒ«å›ºæœ‰ã®è¨­å®š
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å®šç¾©
CREATE TABLE auto_response_keywords (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  rule_id UUID NOT NULL REFERENCES auto_response_rules(id) ON DELETE CASCADE,
  keyword TEXT NOT NULL,
  match_type TEXT DEFAULT 'partial', -- 'exact', 'partial', 'startsWith', 'endsWith', 'regex'
  case_sensitive BOOLEAN DEFAULT false,
  exclude_keywords TEXT[] DEFAULT '{}', -- é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é…åˆ—
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚·ãƒŠãƒªã‚ªå®šç¾©
CREATE TABLE auto_response_scenarios (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  rule_id UUID NOT NULL REFERENCES auto_response_rules(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  timeout_minutes INTEGER DEFAULT 30, -- ä¼šè©±ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚·ãƒŠãƒªã‚ªã‚¹ãƒ†ãƒƒãƒ—
CREATE TABLE auto_response_scenario_steps (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  scenario_id UUID NOT NULL REFERENCES auto_response_scenarios(id) ON DELETE CASCADE,
  step_number INTEGER NOT NULL,
  message_type TEXT NOT NULL, -- 'text', 'flex', 'template'
  message_content JSONB NOT NULL,
  expected_input_type TEXT, -- 'text', 'number', 'date', 'choice', 'any'
  validation_rules JSONB DEFAULT '{}', -- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«
  branches JSONB DEFAULT '[]', -- åˆ†å²æ¡ä»¶é…åˆ—
  actions JSONB DEFAULT '[]', -- ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é…åˆ—
  next_step_id UUID REFERENCES auto_response_scenario_steps(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(scenario_id, step_number)
);

-- ä¼šè©±çŠ¶æ…‹ç®¡ç†
CREATE TABLE auto_response_conversations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  friend_id UUID NOT NULL REFERENCES friends(id) ON DELETE CASCADE,
  scenario_id UUID NOT NULL REFERENCES auto_response_scenarios(id) ON DELETE CASCADE,
  current_step_id UUID REFERENCES auto_response_scenario_steps(id),
  status TEXT DEFAULT 'in_progress', -- 'in_progress', 'completed', 'timeout', 'cancelled'
  conversation_data JSONB DEFAULT '{}', -- ä¼šè©±ã§åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿
  started_at TIMESTAMPTZ DEFAULT NOW(),
  last_interaction_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- å¿œç­”ãƒ­ã‚°
CREATE TABLE auto_response_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  friend_id UUID NOT NULL REFERENCES friends(id) ON DELETE CASCADE,
  rule_id UUID REFERENCES auto_response_rules(id) ON DELETE SET NULL,
  scenario_id UUID REFERENCES auto_response_scenarios(id) ON DELETE SET NULL,
  trigger_message TEXT NOT NULL, -- å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  response_type TEXT NOT NULL, -- 'keyword', 'scenario', 'ai', 'none'
  response_sent BOOLEAN DEFAULT true,
  response_content JSONB, -- é€ä¿¡ã—ãŸå¿œç­”å†…å®¹
  processing_time_ms INTEGER, -- å‡¦ç†æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- AIå¿œç­”è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
CREATE TABLE auto_response_ai_settings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  enabled BOOLEAN DEFAULT false,
  openai_api_key TEXT, -- æš—å·åŒ–æ¨å¥¨
  model TEXT DEFAULT 'gpt-3.5-turbo',
  system_prompt TEXT,
  temperature DECIMAL(2,1) DEFAULT 0.7,
  max_tokens INTEGER DEFAULT 500,
  context_history_count INTEGER DEFAULT 5,
  fallback_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id)
);

-- AIä¼šè©±å±¥æ­´
CREATE TABLE auto_response_ai_conversations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  friend_id UUID NOT NULL REFERENCES friends(id) ON DELETE CASCADE,
  role TEXT NOT NULL, -- 'user', 'assistant', 'system'
  content TEXT NOT NULL,
  tokens_used INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 3.2 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

```sql
-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_auto_response_rules_user_status ON auto_response_rules(user_id, status);
CREATE INDEX idx_auto_response_rules_type_priority ON auto_response_rules(type, priority DESC);
CREATE INDEX idx_auto_response_keywords_rule ON auto_response_keywords(rule_id);
CREATE INDEX idx_auto_response_keywords_keyword ON auto_response_keywords(keyword);
CREATE INDEX idx_auto_response_scenarios_rule ON auto_response_scenarios(rule_id);
CREATE INDEX idx_auto_response_scenario_steps_scenario ON auto_response_scenario_steps(scenario_id, step_number);
CREATE INDEX idx_auto_response_conversations_friend_status ON auto_response_conversations(friend_id, status);
CREATE INDEX idx_auto_response_conversations_scenario ON auto_response_conversations(scenario_id, status);
CREATE INDEX idx_auto_response_logs_friend ON auto_response_logs(friend_id, created_at DESC);
CREATE INDEX idx_auto_response_logs_rule ON auto_response_logs(rule_id, created_at DESC);
CREATE INDEX idx_auto_response_ai_conversations_friend ON auto_response_ai_conversations(friend_id, created_at DESC);
```

### 3.3 RLS (Row Level Security)

```sql
-- è‡ªå‹•å¿œç­”ãƒ«ãƒ¼ãƒ«
ALTER TABLE auto_response_rules ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own auto response rules"
ON auto_response_rules FOR ALL
USING (user_id = auth.uid());

-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
ALTER TABLE auto_response_keywords ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own keywords"
ON auto_response_keywords FOR ALL
USING (
  rule_id IN (
    SELECT id FROM auto_response_rules WHERE user_id = auth.uid()
  )
);

-- ã‚·ãƒŠãƒªã‚ª
ALTER TABLE auto_response_scenarios ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own scenarios"
ON auto_response_scenarios FOR ALL
USING (
  rule_id IN (
    SELECT id FROM auto_response_rules WHERE user_id = auth.uid()
  )
);

-- ã‚¹ãƒ†ãƒƒãƒ—
ALTER TABLE auto_response_scenario_steps ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own scenario steps"
ON auto_response_scenario_steps FOR ALL
USING (
  scenario_id IN (
    SELECT s.id FROM auto_response_scenarios s
    JOIN auto_response_rules r ON s.rule_id = r.id
    WHERE r.user_id = auth.uid()
  )
);

-- ä¼šè©±çŠ¶æ…‹
ALTER TABLE auto_response_conversations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own conversations"
ON auto_response_conversations FOR SELECT
USING (
  friend_id IN (
    SELECT id FROM friends WHERE user_id = auth.uid()
  )
);

-- ãƒ­ã‚°
ALTER TABLE auto_response_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own logs"
ON auto_response_logs FOR SELECT
USING (
  friend_id IN (
    SELECT id FROM friends WHERE user_id = auth.uid()
  )
);

-- AIè¨­å®š
ALTER TABLE auto_response_ai_settings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own AI settings"
ON auto_response_ai_settings FOR ALL
USING (user_id = auth.uid());

-- AIä¼šè©±å±¥æ­´
ALTER TABLE auto_response_ai_conversations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own AI conversations"
ON auto_response_ai_conversations FOR SELECT
USING (
  friend_id IN (
    SELECT id FROM friends WHERE user_id = auth.uid()
  )
);
```

---

## 4. ç”»é¢è¨­è¨ˆ

### 4.1 è‡ªå‹•å¿œç­”ä¸€è¦§ç”»é¢

**ãƒ‘ã‚¹**: `/dashboard/auto-response`

#### 4.1.1 ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è‡ªå‹•å¿œç­”                                    [+ æ–°è¦ä½œæˆ]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ã™ã¹ã¦] [ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰] [ã‚·ãƒŠãƒªã‚ª] [AI]          ğŸ” æ¤œç´¢      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ âœ“ ã‚ˆãã‚ã‚‹è³ªå• - å–¶æ¥­æ™‚é–“                     å„ªå…ˆåº¦: 8â”‚  â”‚
â”‚ â”‚   ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: å–¶æ¥­æ™‚é–“, å–¶æ¥­, ä½•æ™‚ã¾ã§              â”‚  â”‚
â”‚ â”‚   å¿œç­”: ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸                  [ç·¨é›†] [å‰Šé™¤]â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ âœ“ äºˆç´„å—ä»˜ãƒ•ãƒ­ãƒ¼                          å„ªå…ˆåº¦: 10  â”‚  â”‚
â”‚ â”‚   ã‚·ãƒŠãƒªã‚ª: 5ã‚¹ãƒ†ãƒƒãƒ—                                 â”‚  â”‚
â”‚ â”‚   ãƒˆãƒªã‚¬ãƒ¼: "äºˆç´„", "äºˆç´„ã—ãŸã„"            [ç·¨é›†] [å‰Šé™¤]â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ âš  AIå¿œç­”ï¼ˆæœªè¨­å®šï¼‰                        å„ªå…ˆåº¦: 5   â”‚  â”‚
â”‚ â”‚   ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾å¿œ                                   â”‚  â”‚
â”‚ â”‚   è¨­å®šãŒå¿…è¦ã§ã™                           [è¨­å®š]      â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.1.2 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```tsx
// app/dashboard/auto-response/page.tsx
import { AutoResponseList } from '@/components/auto-response/auto-response-list'
import { AutoResponseStats } from '@/components/auto-response/auto-response-stats'
import { Button } from '@/components/ui/button'
import { PlusIcon } from '@heroicons/react/24/outline'

export default function AutoResponsePage() {
  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold">è‡ªå‹•å¿œç­”</h1>
        <Button href="/dashboard/auto-response/new">
          <PlusIcon className="h-5 w-5 mr-2" />
          æ–°è¦ä½œæˆ
        </Button>
      </div>

      <AutoResponseStats />
      <AutoResponseList />
    </div>
  )
}
```

### 4.2 ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¿œç­”ä½œæˆç”»é¢

**ãƒ‘ã‚¹**: `/dashboard/auto-response/new?type=keyword`

#### 4.2.1 ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¿œç­” æ–°è¦ä½œæˆ                    [ä¿å­˜] [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ åŸºæœ¬è¨­å®š                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ ãƒ«ãƒ¼ãƒ«å *                                              â”‚â”‚
â”‚ â”‚ [ã‚ˆãã‚ã‚‹è³ªå• - å–¶æ¥­æ™‚é–“                              ] â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ èª¬æ˜                                                     â”‚â”‚
â”‚ â”‚ [å–¶æ¥­æ™‚é–“ã«é–¢ã™ã‚‹å•ã„åˆã‚ã›ã«è‡ªå‹•å¿œç­”ã™ã‚‹            ] â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ å„ªå…ˆåº¦ *                                                â”‚â”‚
â”‚ â”‚ [10 â–¼] (1-100, æ•°å­—ãŒå¤§ãã„ã»ã©å„ªå…ˆ)                   â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹                                               â”‚â”‚
â”‚ â”‚ âšª æœ‰åŠ¹  âš« ç„¡åŠ¹                                        â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¨­å®š                                  [+ è¿½åŠ ]     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ 1                                  [å‰Šé™¤]     â”‚â”‚
â”‚ â”‚ [å–¶æ¥­æ™‚é–“                                            ]  â”‚â”‚
â”‚ â”‚ ãƒãƒƒãƒã‚¿ã‚¤ãƒ—: [éƒ¨åˆ†ä¸€è‡´ â–¼]                             â”‚â”‚
â”‚ â”‚ â–¡ å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥                                    â”‚â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚ â”‚ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ 2                                  [å‰Šé™¤]     â”‚â”‚
â”‚ â”‚ [å–¶æ¥­                                                ]  â”‚â”‚
â”‚ â”‚ ãƒãƒƒãƒã‚¿ã‚¤ãƒ—: [éƒ¨åˆ†ä¸€è‡´ â–¼]                             â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚ é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰                                               â”‚
â”‚ â”‚ [ã‚­ãƒ£ãƒ³ã‚»ãƒ«, å¤‰æ›´, é–‰åº—                              ] â”‚â”‚
â”‚                                                             â”‚
â”‚ å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ [ãƒ†ã‚­ã‚¹ãƒˆ â–¼] [Flex Message] [ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ]            â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ å–¶æ¥­æ™‚é–“ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š                               â”‚â”‚
â”‚ â”‚ å¹³æ—¥: 9:00 - 18:00                                      â”‚â”‚
â”‚ â”‚ åœŸæ—¥ç¥: 10:00 - 17:00                                   â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ å¤‰æ•°æŒ¿å…¥: [{name}] [{date}] [{time}]                   â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚ æ¡ä»¶è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰                          [å±•é–‹ â–¼]    â”‚
â”‚                                                             â”‚
â”‚ å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰                    [å±•é–‹ â–¼]    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 ã‚·ãƒŠãƒªã‚ªå¿œç­”ä½œæˆç”»é¢

**ãƒ‘ã‚¹**: `/dashboard/auto-response/new?type=scenario`

#### 4.3.1 ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚·ãƒŠãƒªã‚ªå¿œç­” æ–°è¦ä½œæˆ                      [ä¿å­˜] [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ åŸºæœ¬è¨­å®š                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ ã‚·ãƒŠãƒªã‚ªå *                                            â”‚â”‚
â”‚ â”‚ [äºˆç´„å—ä»˜ãƒ•ãƒ­ãƒ¼                                        ] â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ ãƒˆãƒªã‚¬ãƒ¼ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ *                       [+ è¿½åŠ ]     â”‚â”‚
â”‚ â”‚ â€¢ äºˆç´„                                      [å‰Šé™¤]      â”‚â”‚
â”‚ â”‚ â€¢ äºˆç´„ã—ãŸã„                                [å‰Šé™¤]      â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“                                         â”‚â”‚
â”‚ â”‚ [30] åˆ†ï¼ˆä¼šè©±ãŒä¸­æ–­ã—ãŸå ´åˆã®ãƒªã‚»ãƒƒãƒˆæ™‚é–“ï¼‰             â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚ ã‚¹ãƒ†ãƒƒãƒ—è¨­å®š                               [+ ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ ] â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ ğŸ¯ ã‚¹ãƒ†ãƒƒãƒ— 1: åå‰ç¢ºèª                     [ç·¨é›†] [å‰Šé™¤]â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:                                              â”‚â”‚
â”‚ â”‚ ã€Œã”äºˆç´„ã‚’æ‰¿ã‚Šã¾ã™ã€‚ãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„ã€             â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ æœŸå¾…ã™ã‚‹å…¥åŠ›: ãƒ†ã‚­ã‚¹ãƒˆ                                   â”‚â”‚
â”‚ â”‚ ä¿å­˜å…ˆå¤‰æ•°: {customer_name}                             â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: ã‚¹ãƒ†ãƒƒãƒ— 2 â†’                              â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ ğŸ¯ ã‚¹ãƒ†ãƒƒãƒ— 2: æ—¥æ™‚å…¥åŠ›                     [ç·¨é›†] [å‰Šé™¤]â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:                                              â”‚â”‚
â”‚ â”‚ ã€Œ{customer_name}æ§˜ã€ã”å¸Œæœ›ã®æ—¥æ™‚ã‚’æ•™ãˆã¦ãã ã•ã„ã€      â”‚â”‚
â”‚ â”‚ ã€Œï¼ˆä¾‹: 12/25 14:00ï¼‰ã€                                 â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ æœŸå¾…ã™ã‚‹å…¥åŠ›: æ—¥æ™‚å½¢å¼                                   â”‚â”‚
â”‚ â”‚ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: æ—¥ä»˜å½¢å¼ãƒã‚§ãƒƒã‚¯                         â”‚â”‚
â”‚ â”‚ ä¿å­˜å…ˆå¤‰æ•°: {reservation_datetime}                      â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ åˆ†å²:                                                    â”‚â”‚
â”‚ â”‚ â”œâ”€ æœ‰åŠ¹ãªæ—¥æ™‚ â†’ ã‚¹ãƒ†ãƒƒãƒ— 3                              â”‚â”‚
â”‚ â”‚ â””â”€ ç„¡åŠ¹ãªå½¢å¼ â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â†’ ã‚¹ãƒ†ãƒƒãƒ— 2ã¸æˆ»ã‚‹     â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ ğŸ¯ ã‚¹ãƒ†ãƒƒãƒ— 3: ç¢ºèª                         [ç·¨é›†] [å‰Šé™¤]â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:                                              â”‚â”‚
â”‚ â”‚ ã€Œä»¥ä¸‹ã®å†…å®¹ã§ã”äºˆç´„ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿã€                   â”‚â”‚
â”‚ â”‚ ã€ŒãŠåå‰: {customer_name}ã€                             â”‚â”‚
â”‚ â”‚ ã€Œæ—¥æ™‚: {reservation_datetime}ã€                        â”‚â”‚
â”‚ â”‚ ã€Œ[ã¯ã„] [ã„ã„ãˆ]ã€ï¼ˆã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ï¼‰                 â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ æœŸå¾…ã™ã‚‹å…¥åŠ›: é¸æŠè‚¢ï¼ˆã¯ã„/ã„ã„ãˆï¼‰                     â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ åˆ†å²:                                                    â”‚â”‚
â”‚ â”‚ â”œâ”€ ã¯ã„ â†’ ã‚¹ãƒ†ãƒƒãƒ— 4ï¼ˆå®Œäº†ï¼‰                            â”‚â”‚
â”‚ â”‚ â””â”€ ã„ã„ãˆ â†’ ã‚¹ãƒ†ãƒƒãƒ— 1ã¸æˆ»ã‚‹                            â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ âœ… ã‚¹ãƒ†ãƒƒãƒ— 4: å®Œäº†                         [ç·¨é›†] [å‰Šé™¤]â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:                                              â”‚â”‚
â”‚ â”‚ ã€Œã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã€                         â”‚â”‚
â”‚ â”‚ ã€Œäºˆç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€                         â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³:                                          â”‚â”‚
â”‚ â”‚ â€¢ ã‚¿ã‚°ä»˜ä¸: "äºˆç´„å®Œäº†"                                  â”‚â”‚
â”‚ â”‚ â€¢ äºˆç´„ãƒ‡ãƒ¼ã‚¿ä¿å­˜                                         â”‚â”‚
â”‚ â”‚ â€¢ ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¨­å®šï¼ˆå‰æ—¥ï¼‰                               â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ ã‚·ãƒŠãƒªã‚ªçµ‚äº†                                             â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 AIå¿œç­”è¨­å®šç”»é¢

**ãƒ‘ã‚¹**: `/dashboard/auto-response/ai-settings`

#### 4.4.1 ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AIå¿œç­”è¨­å®š                                  [ä¿å­˜] [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ âš¡ AIå¿œç­”ã‚’æœ‰åŠ¹åŒ–                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ AIå¿œç­”æ©Ÿèƒ½                                              â”‚â”‚
â”‚ â”‚ [âœ“] AIå¿œç­”ã‚’æœ‰åŠ¹ã«ã™ã‚‹                                  â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ âš  ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¿œç­”ã¨ã‚·ãƒŠãƒªã‚ªã§ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆã«ã€     â”‚â”‚
â”‚ â”‚   ChatGPTãŒè‡ªå‹•å¿œç­”ã—ã¾ã™                               â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚ OpenAI APIè¨­å®š                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ APIã‚­ãƒ¼ *                                               â”‚â”‚
â”‚ â”‚ [sk-...                                              ]  â”‚â”‚
â”‚ â”‚ ğŸ“– APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•                                    â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ ãƒ¢ãƒ‡ãƒ«                                                   â”‚â”‚
â”‚ â”‚ [gpt-4 â–¼]                                               â”‚â”‚
â”‚ â”‚ â€¢ gpt-4: æœ€é«˜å“è³ªï¼ˆé«˜ã‚³ã‚¹ãƒˆï¼‰                           â”‚â”‚
â”‚ â”‚ â€¢ gpt-4-turbo: ãƒãƒ©ãƒ³ã‚¹å‹ï¼ˆæ¨å¥¨ï¼‰                       â”‚â”‚
â”‚ â”‚ â€¢ gpt-3.5-turbo: é«˜é€Ÿãƒ»ä½ã‚³ã‚¹ãƒˆ                         â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ æ¸©åº¦ï¼ˆTemperatureï¼‰                                      â”‚â”‚
â”‚ â”‚ [0.7] â—€â•â•â•â•â•â•â•â—â•â•â•â–¶ (0.0 - 1.0)                       â”‚â”‚
â”‚ â”‚ ä½ã„: ä¸€è²«æ€§é‡è¦–  é«˜ã„: å‰µé€ æ€§é‡è¦–                      â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°                                           â”‚â”‚
â”‚ â”‚ [500]                                                   â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ ä¼šè©±å±¥æ­´ä¿æŒæ•°                                           â”‚â”‚
â”‚ â”‚ [5] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸                                          â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚ ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ ã‚ãªãŸã¯ {business_name} ã®LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®         â”‚â”‚
â”‚ â”‚ ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆæ‹…å½“ã§ã™ã€‚                             â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ ã€åŸºæœ¬æƒ…å ±ã€‘                                             â”‚â”‚
â”‚ â”‚ - å–¶æ¥­æ™‚é–“: å¹³æ—¥ 9:00-18:00                             â”‚â”‚
â”‚ â”‚ - æä¾›ã‚µãƒ¼ãƒ“ã‚¹: ...                                     â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ ã€å¯¾å¿œæ–¹é‡ã€‘                                             â”‚â”‚
â”‚ â”‚ - ä¸å¯§ã§è¦ªã—ã¿ã‚„ã™ã„å£èª¿ã§å¯¾å¿œã—ã¦ãã ã•ã„               â”‚â”‚
â”‚ â”‚ - ä¸æ˜ãªç‚¹ã¯æ­£ç›´ã«ä¼ãˆã¦ãã ã•ã„                         â”‚â”‚
â”‚ â”‚                                                         â”‚â”‚
â”‚ â”‚ å¤‰æ•°: {business_name}, {business_hours}, {services}     â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ AIå¿œç­”å¤±æ•—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸                                â”‚â”‚
â”‚ â”‚ [ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚    ] â”‚â”‚
â”‚ â”‚ [æ‹…å½“è€…ãŒç¢ºèªæ¬¡ç¬¬ã€ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚        ]  â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚ [æ¥ç¶šãƒ†ã‚¹ãƒˆ] [ä¿å­˜]                                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.5 å¿œç­”ãƒ­ã‚°ç”»é¢

**ãƒ‘ã‚¹**: `/dashboard/auto-response/logs`

#### 4.5.1 ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è‡ªå‹•å¿œç­”ãƒ­ã‚°                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æœŸé–“: [éå»7æ—¥é–“ â–¼]  ãƒ«ãƒ¼ãƒ«: [ã™ã¹ã¦ â–¼]  ğŸ” æ¤œç´¢          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ æ—¥æ™‚           å‹ã ã¡      å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸    å¿œç­”      çµæœ â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ 12/25 14:30   å±±ç”°å¤ªéƒ    å–¶æ¥­æ™‚é–“ã¯ï¼Ÿ    ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰   âœ“  â”‚
â”‚ 12/25 14:28   ä½è—¤èŠ±å­    äºˆç´„ã—ãŸã„      ã‚·ãƒŠãƒªã‚ª     âœ“  â”‚
â”‚ 12/25 14:25   ç”°ä¸­ä¸€éƒ    ã“ã‚“ã«ã¡ã¯      AIå¿œç­”       âœ“  â”‚
â”‚ 12/25 14:20   éˆ´æœ¨æ¬¡éƒ    ä¾¡æ ¼æ•™ãˆã¦      ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰   âœ—  â”‚
â”‚                                                             â”‚
â”‚ [ã‚‚ã£ã¨è¦‹ã‚‹]                                                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. å¿œç­”ãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆ

### 5.1 å¿œç­”å‡¦ç†ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[LINE Webhookå—ä¿¡] --> B{ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—}
    B -->|ãƒ†ã‚­ã‚¹ãƒˆ| C[è‡ªå‹•å¿œç­”å‡¦ç†é–‹å§‹]
    B -->|ãã‚Œä»¥å¤–| Z[ã‚¹ã‚­ãƒƒãƒ—]

    C --> D{ä¼šè©±ä¸­ï¼Ÿ}
    D -->|Yes| E[ã‚·ãƒŠãƒªã‚ªç¶™ç¶šå‡¦ç†]
    D -->|No| F[æ–°è¦å¿œç­”åˆ¤å®š]

    E --> E1[ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—å–å¾—]
    E1 --> E2[å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³]
    E2 --> E3{æœ‰åŠ¹ï¼Ÿ}
    E3 -->|Yes| E4[ãƒ‡ãƒ¼ã‚¿ä¿å­˜]
    E3 -->|No| E5[ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸]
    E4 --> E6[æ¬¡ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®š]
    E6 --> E7[å¿œç­”é€ä¿¡]
    E7 --> E8[ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°]

    F --> F1[ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ«ãƒ¼ãƒ«å–å¾—]
    F1 --> F2[å„ªå…ˆåº¦é †ã‚½ãƒ¼ãƒˆ]
    F2 --> F3{æ¡ä»¶ãƒãƒƒãƒï¼Ÿ}

    F3 -->|ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰| F4[ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°]
    F3 -->|ã‚·ãƒŠãƒªã‚ª| F5[ã‚·ãƒŠãƒªã‚ªé–‹å§‹]
    F3 -->|AI| F6[AIå¿œç­”]
    F3 -->|ãªã—| F7[å¿œç­”ãªã—]

    F4 --> G[æ¡ä»¶ãƒã‚§ãƒƒã‚¯]
    F5 --> G
    F6 --> G

    G --> G1{æ¡ä»¶ã‚¯ãƒªã‚¢ï¼Ÿ}
    G1 -->|Yes| H[å¿œç­”é€ä¿¡]
    G1 -->|No| F3

    H --> I[ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ]
    I --> J[ãƒ­ã‚°è¨˜éŒ²]
    J --> K[å®Œäº†]
```

### 5.2 ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

```typescript
// lib/auto-response/keyword-matcher.ts

interface KeywordMatch {
  rule_id: string
  keyword: string
  match_type: MatchType
  priority: number
}

async function matchKeyword(
  message: string,
  userId: string
): Promise<KeywordMatch[]> {
  // 1. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ«ãƒ¼ãƒ«å–å¾—
  const rules = await getActiveKeywordRules(userId)

  const matches: KeywordMatch[] = []

  for (const rule of rules) {
    for (const keyword of rule.keywords) {
      // 2. ãƒãƒƒãƒãƒ³ã‚°ãƒã‚§ãƒƒã‚¯
      const isMatch = checkMatch(message, keyword)

      if (isMatch) {
        // 3. é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
        const hasExcluded = checkExcludedKeywords(
          message,
          keyword.exclude_keywords
        )

        if (!hasExcluded) {
          matches.push({
            rule_id: rule.id,
            keyword: keyword.keyword,
            match_type: keyword.match_type,
            priority: rule.priority
          })
        }
      }
    }
  }

  // 4. å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆ
  return matches.sort((a, b) => b.priority - a.priority)
}

function checkMatch(
  message: string,
  keyword: AutoResponseKeyword
): boolean {
  const msg = keyword.case_sensitive
    ? message
    : message.toLowerCase()

  const kw = keyword.case_sensitive
    ? keyword.keyword
    : keyword.keyword.toLowerCase()

  switch (keyword.match_type) {
    case 'exact':
      return msg === kw

    case 'partial':
      return msg.includes(kw)

    case 'startsWith':
      return msg.startsWith(kw)

    case 'endsWith':
      return msg.endsWith(kw)

    case 'regex':
      const regex = new RegExp(keyword.keyword)
      return regex.test(message)

    default:
      return false
  }
}

function checkExcludedKeywords(
  message: string,
  excludeKeywords: string[]
): boolean {
  if (!excludeKeywords || excludeKeywords.length === 0) {
    return false
  }

  const lowerMessage = message.toLowerCase()

  return excludeKeywords.some(excluded =>
    lowerMessage.includes(excluded.toLowerCase())
  )
}
```

### 5.3 ã‚·ãƒŠãƒªã‚ªçŠ¶æ…‹ç®¡ç†

```typescript
// lib/auto-response/scenario-manager.ts

class ScenarioManager {
  // ã‚·ãƒŠãƒªã‚ªé–‹å§‹
  async startScenario(
    friendId: string,
    scenarioId: string
  ): Promise<ConversationState> {
    // 1. æ—¢å­˜ã®ä¼šè©±ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    await this.cancelActiveConversations(friendId)

    // 2. æ–°è¦ä¼šè©±ä½œæˆ
    const conversation = await supabase
      .from('auto_response_conversations')
      .insert({
        friend_id: friendId,
        scenario_id: scenarioId,
        status: 'in_progress',
        conversation_data: {},
        started_at: new Date(),
        last_interaction_at: new Date()
      })
      .select()
      .single()

    // 3. æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—å–å¾—
    const firstStep = await this.getFirstStep(scenarioId)

    // 4. æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    await this.sendStepMessage(friendId, firstStep, {})

    // 5. ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°
    await this.updateConversationStep(conversation.id, firstStep.id)

    return conversation
  }

  // ã‚¹ãƒ†ãƒƒãƒ—ç¶™ç¶š
  async continueScenario(
    friendId: string,
    message: string
  ): Promise<void> {
    // 1. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªä¼šè©±å–å¾—
    const conversation = await this.getActiveConversation(friendId)

    if (!conversation) {
      throw new Error('No active conversation')
    }

    // 2. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯
    if (this.isTimedOut(conversation)) {
      await this.timeoutConversation(conversation.id)
      await this.sendTimeoutMessage(friendId)
      return
    }

    // 3. ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—å–å¾—
    const currentStep = await this.getStep(conversation.current_step_id)

    // 4. å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const validation = await this.validateInput(
      message,
      currentStep.expected_input_type,
      currentStep.validation_rules
    )

    if (!validation.isValid) {
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
      await this.sendValidationErrorMessage(
        friendId,
        validation.errorMessage
      )
      return
    }

    // 5. ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    const updatedData = {
      ...conversation.conversation_data,
      [`step_${currentStep.step_number}`]: validation.parsedValue
    }

    await this.updateConversationData(conversation.id, updatedData)

    // 6. åˆ†å²åˆ¤å®š
    const nextStep = await this.determineNextStep(
      currentStep,
      message,
      updatedData
    )

    if (!nextStep) {
      // ã‚·ãƒŠãƒªã‚ªå®Œäº†
      await this.completeScenario(conversation.id, updatedData)
      await this.executeCompletionActions(
        friendId,
        currentStep.actions,
        updatedData
      )
      return
    }

    // 7. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    await this.sendStepMessage(friendId, nextStep, updatedData)

    // 8. ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°
    await this.updateConversationStep(conversation.id, nextStep.id)
    await this.updateLastInteraction(conversation.id)
  }

  // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯
  private isTimedOut(conversation: Conversation): boolean {
    const timeoutMinutes = conversation.scenario.timeout_minutes
    const lastInteraction = new Date(conversation.last_interaction_at)
    const now = new Date()
    const diffMinutes = (now.getTime() - lastInteraction.getTime()) / 60000

    return diffMinutes > timeoutMinutes
  }

  // å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  private async validateInput(
    message: string,
    expectedType: string,
    validationRules: any
  ): Promise<ValidationResult> {
    switch (expectedType) {
      case 'text':
        return this.validateText(message, validationRules)

      case 'number':
        return this.validateNumber(message, validationRules)

      case 'date':
        return this.validateDate(message, validationRules)

      case 'email':
        return this.validateEmail(message, validationRules)

      case 'phone':
        return this.validatePhone(message, validationRules)

      case 'choice':
        return this.validateChoice(message, validationRules)

      case 'any':
        return { isValid: true, parsedValue: message }

      default:
        return { isValid: true, parsedValue: message }
    }
  }

  // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®š
  private async determineNextStep(
    currentStep: ScenarioStep,
    message: string,
    conversationData: any
  ): Promise<ScenarioStep | null> {
    // åˆ†å²ãŒã‚ã‚‹å ´åˆ
    if (currentStep.branches && currentStep.branches.length > 0) {
      for (const branch of currentStep.branches) {
        const conditionMet = await this.evaluateCondition(
          branch.condition,
          message,
          conversationData
        )

        if (conditionMet) {
          // åˆ†å²ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
          await this.executeBranchActions(branch.actions, conversationData)

          // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—å–å¾—
          return this.getStep(branch.next_step_id)
        }
      }
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ¬¡ã‚¹ãƒ†ãƒƒãƒ—
    if (currentStep.next_step_id) {
      return this.getStep(currentStep.next_step_id)
    }

    // æ¬¡ã‚¹ãƒ†ãƒƒãƒ—ãªã—ï¼ˆã‚·ãƒŠãƒªã‚ªçµ‚äº†ï¼‰
    return null
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆå¤‰æ•°ç½®æ›ä»˜ãï¼‰
  private async sendStepMessage(
    friendId: string,
    step: ScenarioStep,
    conversationData: any
  ): Promise<void> {
    // å¤‰æ•°ç½®æ›
    const message = this.replaceVariables(
      step.message_content,
      conversationData
    )

    // LINEé€ä¿¡
    await sendLineMessage(friendId, message)
  }

  // å¤‰æ•°ç½®æ›
  private replaceVariables(
    content: any,
    data: Record<string, any>
  ): any {
    let contentStr = JSON.stringify(content)

    // {variable_name} å½¢å¼ã®å¤‰æ•°ã‚’ç½®æ›
    for (const [key, value] of Object.entries(data)) {
      const regex = new RegExp(`\\{${key}\\}`, 'g')
      contentStr = contentStr.replace(regex, String(value))
    }

    return JSON.parse(contentStr)
  }
}
```

### 5.4 æ¡ä»¶è©•ä¾¡ã‚¨ãƒ³ã‚¸ãƒ³

```typescript
// lib/auto-response/condition-evaluator.ts

class ConditionEvaluator {
  async evaluate(
    conditions: Condition[],
    friend: Friend,
    context: EvaluationContext
  ): Promise<boolean> {
    // ANDæ¡ä»¶ã§è©•ä¾¡
    for (const condition of conditions) {
      const result = await this.evaluateSingle(condition, friend, context)
      if (!result) {
        return false
      }
    }
    return true
  }

  private async evaluateSingle(
    condition: Condition,
    friend: Friend,
    context: EvaluationContext
  ): Promise<boolean> {
    switch (condition.type) {
      case 'friend_attribute':
        return this.evaluateFriendAttribute(condition, friend)

      case 'time':
        return this.evaluateTime(condition)

      case 'behavior':
        return this.evaluateBehavior(condition, friend)

      case 'custom':
        return this.evaluateCustom(condition, context)

      default:
        return true
    }
  }

  // å‹ã ã¡å±æ€§æ¡ä»¶
  private async evaluateFriendAttribute(
    condition: FriendAttributeCondition,
    friend: Friend
  ): Promise<boolean> {
    switch (condition.type) {
      case 'tag':
        return this.evaluateTag(condition, friend)

      case 'segment':
        return this.evaluateSegment(condition, friend)

      case 'custom_field':
        return this.evaluateCustomField(condition, friend)

      default:
        return false
    }
  }

  // ã‚¿ã‚°æ¡ä»¶è©•ä¾¡
  private async evaluateTag(
    condition: FriendAttributeCondition,
    friend: Friend
  ): Promise<boolean> {
    const friendTags = await getFriendTags(friend.id)
    const tagIds = friendTags.map(t => t.tag_id)
    const conditionTags = Array.isArray(condition.value)
      ? condition.value
      : [condition.value]

    switch (condition.operator) {
      case 'has':
        return conditionTags.some(tag => tagIds.includes(tag))

      case 'not_has':
        return !conditionTags.some(tag => tagIds.includes(tag))

      case 'has_all':
        return conditionTags.every(tag => tagIds.includes(tag))

      default:
        return false
    }
  }

  // æ™‚é–“æ¡ä»¶è©•ä¾¡
  private evaluateTime(condition: TimeCondition): boolean {
    const now = new Date()

    // æ™‚é–“å¸¯ãƒã‚§ãƒƒã‚¯
    if (condition.time_range) {
      const currentTime = format(now, 'HH:mm')
      if (currentTime < condition.time_range.start ||
          currentTime > condition.time_range.end) {
        return false
      }
    }

    // æ›œæ—¥ãƒã‚§ãƒƒã‚¯
    if (condition.day_of_week) {
      const dayOfWeek = now.getDay()
      if (!condition.day_of_week.includes(dayOfWeek)) {
        return false
      }
    }

    // æœŸé–“ãƒã‚§ãƒƒã‚¯
    if (condition.date_range) {
      const currentDate = format(now, 'yyyy-MM-dd')
      if (currentDate < condition.date_range.start ||
          currentDate > condition.date_range.end) {
        return false
      }
    }

    return true
  }

  // è¡Œå‹•æ¡ä»¶è©•ä¾¡
  private async evaluateBehavior(
    condition: BehaviorCondition,
    friend: Friend
  ): Promise<boolean> {
    switch (condition.type) {
      case 'message_opened':
        return this.evaluateMessageOpened(condition, friend)

      case 'url_clicked':
        return this.evaluateUrlClicked(condition, friend)

      case 'form_submitted':
        return this.evaluateFormSubmitted(condition, friend)

      case 'action_count':
        return this.evaluateActionCount(condition, friend)

      default:
        return false
    }
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–‹å°æ¡ä»¶
  private async evaluateMessageOpened(
    condition: BehaviorCondition,
    friend: Friend
  ): Promise<boolean> {
    if (!condition.message_opened) return false

    const { message_id, within_days } = condition.message_opened
    const sinceDate = subDays(new Date(), within_days)

    const opened = await supabase
      .from('message_recipients')
      .select('read_at')
      .eq('message_id', message_id)
      .eq('friend_id', friend.id)
      .not('read_at', 'is', null)
      .gte('read_at', sinceDate.toISOString())
      .single()

    return !!opened
  }
}
```

---

## 6. APIè¨­è¨ˆ

### 6.1 Server Actions

```typescript
// app/actions/auto-response.ts
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'

// ãƒ«ãƒ¼ãƒ«ä¸€è¦§å–å¾—
export async function getAutoResponseRules() {
  const supabase = await createClient()

  const { data, error } = await supabase
    .from('auto_response_rules')
    .select(`
      *,
      keywords:auto_response_keywords(*),
      scenarios:auto_response_scenarios(*)
    `)
    .order('priority', { ascending: false })

  if (error) throw error
  return data
}

// ãƒ«ãƒ¼ãƒ«ä½œæˆ
export async function createAutoResponseRule(
  formData: FormData
) {
  const supabase = await createClient()

  const ruleData = {
    name: formData.get('name') as string,
    description: formData.get('description') as string,
    type: formData.get('type') as string,
    priority: parseInt(formData.get('priority') as string),
    status: formData.get('status') as string,
    conditions: JSON.parse(formData.get('conditions') as string || '{}'),
    settings: JSON.parse(formData.get('settings') as string || '{}'),
  }

  const { data: rule, error } = await supabase
    .from('auto_response_rules')
    .insert(ruleData)
    .select()
    .single()

  if (error) throw error

  // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®è¿½åŠ 
  if (ruleData.type === 'keyword') {
    const keywords = JSON.parse(formData.get('keywords') as string)

    await supabase
      .from('auto_response_keywords')
      .insert(
        keywords.map((kw: any) => ({
          rule_id: rule.id,
          ...kw
        }))
      )
  }

  revalidatePath('/dashboard/auto-response')
  return rule
}

// ãƒ«ãƒ¼ãƒ«æ›´æ–°
export async function updateAutoResponseRule(
  ruleId: string,
  formData: FormData
) {
  const supabase = await createClient()

  const updateData = {
    name: formData.get('name') as string,
    description: formData.get('description') as string,
    priority: parseInt(formData.get('priority') as string),
    status: formData.get('status') as string,
    conditions: JSON.parse(formData.get('conditions') as string || '{}'),
    settings: JSON.parse(formData.get('settings') as string || '{}'),
    updated_at: new Date().toISOString()
  }

  const { error } = await supabase
    .from('auto_response_rules')
    .update(updateData)
    .eq('id', ruleId)

  if (error) throw error

  revalidatePath('/dashboard/auto-response')
  revalidatePath(`/dashboard/auto-response/${ruleId}`)
}

// ãƒ«ãƒ¼ãƒ«å‰Šé™¤
export async function deleteAutoResponseRule(ruleId: string) {
  const supabase = await createClient()

  const { error } = await supabase
    .from('auto_response_rules')
    .delete()
    .eq('id', ruleId)

  if (error) throw error

  revalidatePath('/dashboard/auto-response')
}

// ã‚·ãƒŠãƒªã‚ªä½œæˆ
export async function createScenario(
  ruleId: string,
  scenarioData: any
) {
  const supabase = await createClient()

  const { data: scenario, error: scenarioError } = await supabase
    .from('auto_response_scenarios')
    .insert({
      rule_id: ruleId,
      name: scenarioData.name,
      description: scenarioData.description,
      timeout_minutes: scenarioData.timeout_minutes
    })
    .select()
    .single()

  if (scenarioError) throw scenarioError

  // ã‚¹ãƒ†ãƒƒãƒ—ä½œæˆ
  if (scenarioData.steps && scenarioData.steps.length > 0) {
    const steps = scenarioData.steps.map((step: any, index: number) => ({
      scenario_id: scenario.id,
      step_number: index + 1,
      ...step
    }))

    const { error: stepsError } = await supabase
      .from('auto_response_scenario_steps')
      .insert(steps)

    if (stepsError) throw stepsError
  }

  revalidatePath('/dashboard/auto-response')
  return scenario
}

// ãƒ­ã‚°å–å¾—
export async function getAutoResponseLogs(
  filters: {
    startDate?: string
    endDate?: string
    ruleId?: string
    friendId?: string
  }
) {
  const supabase = await createClient()

  let query = supabase
    .from('auto_response_logs')
    .select(`
      *,
      friend:friends(id, display_name),
      rule:auto_response_rules(id, name)
    `)
    .order('created_at', { ascending: false })

  if (filters.startDate) {
    query = query.gte('created_at', filters.startDate)
  }

  if (filters.endDate) {
    query = query.lte('created_at', filters.endDate)
  }

  if (filters.ruleId) {
    query = query.eq('rule_id', filters.ruleId)
  }

  if (filters.friendId) {
    query = query.eq('friend_id', filters.friendId)
  }

  const { data, error } = await query.limit(100)

  if (error) throw error
  return data
}

// AIè¨­å®šå–å¾—
export async function getAISettings() {
  const supabase = await createClient()

  const { data, error } = await supabase
    .from('auto_response_ai_settings')
    .select('*')
    .single()

  if (error && error.code !== 'PGRST116') throw error
  return data
}

// AIè¨­å®šæ›´æ–°
export async function updateAISettings(settings: any) {
  const supabase = await createClient()

  const { data, error } = await supabase
    .from('auto_response_ai_settings')
    .upsert({
      ...settings,
      updated_at: new Date().toISOString()
    })
    .select()
    .single()

  if (error) throw error

  revalidatePath('/dashboard/auto-response/ai-settings')
  return data
}
```

---

## 7. Edge Functionsè¨­è¨ˆ

### 7.1 process-auto-response

**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/functions/process-auto-response/index.ts`

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

interface WebhookPayload {
  events: LineEvent[]
}

interface LineEvent {
  type: string
  message?: {
    type: string
    id: string
    text?: string
  }
  source: {
    type: string
    userId: string
  }
  replyToken: string
  timestamp: number
}

serve(async (req) => {
  try {
    const payload: WebhookPayload = await req.json()

    // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    )

    for (const event of payload.events) {
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿å‡¦ç†
      if (event.type !== 'message' || event.message?.type !== 'text') {
        continue
      }

      const lineUserId = event.source.userId
      const messageText = event.message.text || ''

      // å‹ã ã¡æƒ…å ±å–å¾—
      const { data: friend } = await supabaseClient
        .from('friends')
        .select('*')
        .eq('line_user_id', lineUserId)
        .single()

      if (!friend) continue

      // è‡ªå‹•å¿œç­”å‡¦ç†
      await processAutoResponse(
        supabaseClient,
        friend,
        messageText,
        event.replyToken
      )
    }

    return new Response(JSON.stringify({ success: true }), {
      headers: { 'Content-Type': 'application/json' },
      status: 200
    })

  } catch (error) {
    console.error('Error:', error)
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { 'Content-Type': 'application/json' },
      status: 500
    })
  }
})

async function processAutoResponse(
  supabase: any,
  friend: any,
  message: string,
  replyToken: string
) {
  const startTime = Date.now()

  try {
    // 1. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªä¼šè©±ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const { data: activeConversation } = await supabase
      .from('auto_response_conversations')
      .select('*, scenario:auto_response_scenarios(*)')
      .eq('friend_id', friend.id)
      .eq('status', 'in_progress')
      .single()

    if (activeConversation) {
      // ã‚·ãƒŠãƒªã‚ªç¶™ç¶šå‡¦ç†
      await continueScenario(
        supabase,
        friend,
        activeConversation,
        message,
        replyToken
      )
      return
    }

    // 2. æ–°è¦å¿œç­”åˆ¤å®š
    const matchedRule = await findMatchingRule(
      supabase,
      friend,
      message
    )

    if (!matchedRule) {
      // ãƒãƒƒãƒãªã— â†’ AIå¿œç­”è©¦è¡Œ
      await tryAIResponse(supabase, friend, message, replyToken)
      return
    }

    // 3. ãƒ«ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ—åˆ¥å‡¦ç†
    switch (matchedRule.type) {
      case 'keyword':
        await handleKeywordResponse(
          supabase,
          friend,
          matchedRule,
          message,
          replyToken
        )
        break

      case 'scenario':
        await startScenario(
          supabase,
          friend,
          matchedRule,
          replyToken
        )
        break

      default:
        console.log('Unknown rule type:', matchedRule.type)
    }

  } catch (error) {
    console.error('Auto response error:', error)

    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ²
    await supabase
      .from('auto_response_logs')
      .insert({
        friend_id: friend.id,
        trigger_message: message,
        response_type: 'none',
        response_sent: false,
        error_message: error.message,
        processing_time_ms: Date.now() - startTime
      })
  }
}

async function findMatchingRule(
  supabase: any,
  friend: any,
  message: string
) {
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ«ãƒ¼ãƒ«å–å¾—
  const { data: rules } = await supabase
    .from('auto_response_rules')
    .select(`
      *,
      keywords:auto_response_keywords(*),
      scenarios:auto_response_scenarios(*)
    `)
    .eq('status', 'active')
    .order('priority', { ascending: false })

  if (!rules || rules.length === 0) return null

  for (const rule of rules) {
    // æ¡ä»¶ãƒã‚§ãƒƒã‚¯
    const conditionsMet = await evaluateConditions(
      supabase,
      friend,
      rule.conditions
    )

    if (!conditionsMet) continue

    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°
    if (rule.type === 'keyword' && rule.keywords) {
      for (const keyword of rule.keywords) {
        const isMatch = checkKeywordMatch(message, keyword)

        if (isMatch) {
          // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
          const hasExcluded = checkExcludedKeywords(
            message,
            keyword.exclude_keywords
          )

          if (!hasExcluded) {
            return rule
          }
        }
      }
    }

    // ã‚·ãƒŠãƒªã‚ªãƒˆãƒªã‚¬ãƒ¼ãƒãƒƒãƒãƒ³ã‚°
    if (rule.type === 'scenario' && rule.settings?.trigger_keywords) {
      const triggers = rule.settings.trigger_keywords
      const isMatch = triggers.some((trigger: string) =>
        message.toLowerCase().includes(trigger.toLowerCase())
      )

      if (isMatch) {
        return rule
      }
    }
  }

  return null
}

function checkKeywordMatch(
  message: string,
  keyword: any
): boolean {
  const msg = keyword.case_sensitive
    ? message
    : message.toLowerCase()
  const kw = keyword.case_sensitive
    ? keyword.keyword
    : keyword.keyword.toLowerCase()

  switch (keyword.match_type) {
    case 'exact':
      return msg === kw
    case 'partial':
      return msg.includes(kw)
    case 'startsWith':
      return msg.startsWith(kw)
    case 'endsWith':
      return msg.endsWith(kw)
    case 'regex':
      const regex = new RegExp(keyword.keyword)
      return regex.test(message)
    default:
      return false
  }
}

function checkExcludedKeywords(
  message: string,
  excludeKeywords: string[]
): boolean {
  if (!excludeKeywords || excludeKeywords.length === 0) {
    return false
  }

  const lowerMessage = message.toLowerCase()
  return excludeKeywords.some(excluded =>
    lowerMessage.includes(excluded.toLowerCase())
  )
}

async function evaluateConditions(
  supabase: any,
  friend: any,
  conditions: any
): Promise<boolean> {
  if (!conditions || Object.keys(conditions).length === 0) {
    return true
  }

  // æ™‚é–“æ¡ä»¶
  if (conditions.time) {
    const timeConditionMet = checkTimeCondition(conditions.time)
    if (!timeConditionMet) return false
  }

  // å‹ã ã¡å±æ€§æ¡ä»¶
  if (conditions.friend_attribute) {
    const attrConditionMet = await checkFriendAttributeCondition(
      supabase,
      friend,
      conditions.friend_attribute
    )
    if (!attrConditionMet) return false
  }

  return true
}

function checkTimeCondition(timeCondition: any): boolean {
  const now = new Date()

  // æ™‚é–“å¸¯ãƒã‚§ãƒƒã‚¯
  if (timeCondition.time_range) {
    const currentTime = now.toTimeString().slice(0, 5)
    if (currentTime < timeCondition.time_range.start ||
        currentTime > timeCondition.time_range.end) {
      return false
    }
  }

  // æ›œæ—¥ãƒã‚§ãƒƒã‚¯
  if (timeCondition.day_of_week) {
    const dayOfWeek = now.getDay()
    if (!timeCondition.day_of_week.includes(dayOfWeek)) {
      return false
    }
  }

  return true
}

async function handleKeywordResponse(
  supabase: any,
  friend: any,
  rule: any,
  message: string,
  replyToken: string
) {
  const startTime = Date.now()

  try {
    // å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
    const responseMessage = rule.settings?.response_message

    if (!responseMessage) {
      throw new Error('No response message configured')
    }

    // LINEé€ä¿¡
    await sendLineReplyMessage(replyToken, responseMessage)

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    if (rule.settings?.actions) {
      await executeActions(supabase, friend, rule.settings.actions)
    }

    // ãƒ­ã‚°è¨˜éŒ²
    await supabase
      .from('auto_response_logs')
      .insert({
        friend_id: friend.id,
        rule_id: rule.id,
        trigger_message: message,
        response_type: 'keyword',
        response_sent: true,
        response_content: responseMessage,
        processing_time_ms: Date.now() - startTime
      })

  } catch (error) {
    console.error('Keyword response error:', error)
    throw error
  }
}

async function startScenario(
  supabase: any,
  friend: any,
  rule: any,
  replyToken: string
) {
  try {
    const scenario = rule.scenarios[0]

    if (!scenario) {
      throw new Error('No scenario configured')
    }

    // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—å–å¾—
    const { data: firstStep } = await supabase
      .from('auto_response_scenario_steps')
      .select('*')
      .eq('scenario_id', scenario.id)
      .eq('step_number', 1)
      .single()

    if (!firstStep) {
      throw new Error('No first step found')
    }

    // ä¼šè©±é–‹å§‹
    await supabase
      .from('auto_response_conversations')
      .insert({
        friend_id: friend.id,
        scenario_id: scenario.id,
        current_step_id: firstStep.id,
        status: 'in_progress',
        conversation_data: {},
        started_at: new Date().toISOString(),
        last_interaction_at: new Date().toISOString()
      })

    // æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    await sendLineReplyMessage(replyToken, firstStep.message_content)

  } catch (error) {
    console.error('Start scenario error:', error)
    throw error
  }
}

async function continueScenario(
  supabase: any,
  friend: any,
  conversation: any,
  message: string,
  replyToken: string
) {
  try {
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯
    const timeoutMinutes = conversation.scenario.timeout_minutes
    const lastInteraction = new Date(conversation.last_interaction_at)
    const now = new Date()
    const diffMinutes = (now.getTime() - lastInteraction.getTime()) / 60000

    if (diffMinutes > timeoutMinutes) {
      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      await supabase
        .from('auto_response_conversations')
        .update({
          status: 'timeout',
          completed_at: new Date().toISOString()
        })
        .eq('id', conversation.id)

      await sendLineReplyMessage(
        replyToken,
        { type: 'text', text: 'ä¼šè©±ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚' }
      )
      return
    }

    // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—å–å¾—
    const { data: currentStep } = await supabase
      .from('auto_response_scenario_steps')
      .select('*')
      .eq('id', conversation.current_step_id)
      .single()

    // å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const validation = validateInput(
      message,
      currentStep.expected_input_type,
      currentStep.validation_rules
    )

    if (!validation.isValid) {
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
      await sendLineReplyMessage(
        replyToken,
        { type: 'text', text: validation.errorMessage }
      )
      return
    }

    // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    const updatedData = {
      ...conversation.conversation_data,
      [`step_${currentStep.step_number}`]: validation.parsedValue
    }

    await supabase
      .from('auto_response_conversations')
      .update({
        conversation_data: updatedData,
        last_interaction_at: new Date().toISOString()
      })
      .eq('id', conversation.id)

    // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®š
    let nextStepId = currentStep.next_step_id

    if (currentStep.branches && currentStep.branches.length > 0) {
      for (const branch of currentStep.branches) {
        const conditionMet = evaluateBranchCondition(
          branch.condition,
          message,
          updatedData
        )

        if (conditionMet) {
          nextStepId = branch.next_step_id

          // åˆ†å²ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
          if (branch.actions) {
            await executeActions(supabase, friend, branch.actions)
          }
          break
        }
      }
    }

    if (!nextStepId) {
      // ã‚·ãƒŠãƒªã‚ªå®Œäº†
      await supabase
        .from('auto_response_conversations')
        .update({
          status: 'completed',
          completed_at: new Date().toISOString()
        })
        .eq('id', conversation.id)

      // å®Œäº†ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
      if (currentStep.actions) {
        await executeActions(supabase, friend, currentStep.actions)
      }

      return
    }

    // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—å–å¾—
    const { data: nextStep } = await supabase
      .from('auto_response_scenario_steps')
      .select('*')
      .eq('id', nextStepId)
      .single()

    // ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°
    await supabase
      .from('auto_response_conversations')
      .update({ current_step_id: nextStep.id })
      .eq('id', conversation.id)

    // æ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆå¤‰æ•°ç½®æ›ï¼‰
    const messageContent = replaceVariables(
      nextStep.message_content,
      updatedData
    )

    await sendLineReplyMessage(replyToken, messageContent)

  } catch (error) {
    console.error('Continue scenario error:', error)
    throw error
  }
}

function validateInput(
  message: string,
  expectedType: string,
  validationRules: any
): { isValid: boolean; parsedValue?: any; errorMessage?: string } {
  switch (expectedType) {
    case 'text':
      return { isValid: true, parsedValue: message }

    case 'number':
      const num = parseFloat(message)
      if (isNaN(num)) {
        return {
          isValid: false,
          errorMessage: 'æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'
        }
      }
      return { isValid: true, parsedValue: num }

    case 'date':
      // ç°¡æ˜“çš„ãªæ—¥ä»˜ãƒ‘ãƒ¼ã‚¹
      const dateMatch = message.match(/(\d{1,2})\/(\d{1,2})\s+(\d{1,2}):(\d{2})/)
      if (!dateMatch) {
        return {
          isValid: false,
          errorMessage: 'æ—¥æ™‚ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆä¾‹: 12/25 14:00ï¼‰'
        }
      }
      return { isValid: true, parsedValue: message }

    case 'choice':
      const validChoices = validationRules?.choices || []
      if (!validChoices.includes(message)) {
        return {
          isValid: false,
          errorMessage: `æ¬¡ã®ã„ãšã‚Œã‹ã‚’é¸æŠã—ã¦ãã ã•ã„: ${validChoices.join(', ')}`
        }
      }
      return { isValid: true, parsedValue: message }

    default:
      return { isValid: true, parsedValue: message }
  }
}

function evaluateBranchCondition(
  condition: any,
  message: string,
  conversationData: any
): boolean {
  // ç°¡æ˜“çš„ãªæ¡ä»¶è©•ä¾¡
  if (condition.type === 'equals') {
    return message === condition.value
  }

  if (condition.type === 'contains') {
    return message.includes(condition.value)
  }

  return false
}

function replaceVariables(
  content: any,
  data: Record<string, any>
): any {
  let contentStr = JSON.stringify(content)

  for (const [key, value] of Object.entries(data)) {
    const regex = new RegExp(`\\{${key}\\}`, 'g')
    contentStr = contentStr.replace(regex, String(value))
  }

  return JSON.parse(contentStr)
}

async function executeActions(
  supabase: any,
  friend: any,
  actions: any[]
) {
  for (const action of actions) {
    try {
      switch (action.type) {
        case 'add_tag':
          await addTagsToFriend(supabase, friend.id, action.tag_ids)
          break

        case 'remove_tag':
          await removeTagsFromFriend(supabase, friend.id, action.tag_ids)
          break

        case 'update_custom_field':
          await updateFriendCustomField(
            supabase,
            friend.id,
            action.field_name,
            action.value
          )
          break

        default:
          console.log('Unknown action type:', action.type)
      }
    } catch (error) {
      console.error('Action execution error:', error)
    }
  }
}

async function addTagsToFriend(
  supabase: any,
  friendId: string,
  tagIds: string[]
) {
  const records = tagIds.map(tagId => ({
    friend_id: friendId,
    tag_id: tagId
  }))

  await supabase
    .from('friend_tags')
    .upsert(records, { onConflict: 'friend_id,tag_id' })
}

async function tryAIResponse(
  supabase: any,
  friend: any,
  message: string,
  replyToken: string
) {
  try {
    // AIè¨­å®šå–å¾—
    const { data: aiSettings } = await supabase
      .from('auto_response_ai_settings')
      .select('*')
      .eq('user_id', friend.user_id)
      .single()

    if (!aiSettings || !aiSettings.enabled) {
      // AIç„¡åŠ¹
      return
    }

    // ä¼šè©±å±¥æ­´å–å¾—
    const { data: conversationHistory } = await supabase
      .from('auto_response_ai_conversations')
      .select('*')
      .eq('friend_id', friend.id)
      .order('created_at', { ascending: false })
      .limit(aiSettings.context_history_count)

    // OpenAI APIå‘¼ã³å‡ºã—
    const messages = [
      {
        role: 'system',
        content: aiSettings.system_prompt
      },
      ...(conversationHistory || []).reverse().map((msg: any) => ({
        role: msg.role,
        content: msg.content
      })),
      {
        role: 'user',
        content: message
      }
    ]

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${aiSettings.openai_api_key}`
      },
      body: JSON.stringify({
        model: aiSettings.model,
        messages: messages,
        temperature: aiSettings.temperature,
        max_tokens: aiSettings.max_tokens
      })
    })

    if (!response.ok) {
      throw new Error('OpenAI API error')
    }

    const aiResponse = await response.json()
    const aiMessage = aiResponse.choices[0].message.content

    // LINEé€ä¿¡
    await sendLineReplyMessage(replyToken, {
      type: 'text',
      text: aiMessage
    })

    // ä¼šè©±å±¥æ­´ä¿å­˜
    await supabase
      .from('auto_response_ai_conversations')
      .insert([
        {
          friend_id: friend.id,
          role: 'user',
          content: message,
          tokens_used: aiResponse.usage.prompt_tokens
        },
        {
          friend_id: friend.id,
          role: 'assistant',
          content: aiMessage,
          tokens_used: aiResponse.usage.completion_tokens
        }
      ])

    // ãƒ­ã‚°è¨˜éŒ²
    await supabase
      .from('auto_response_logs')
      .insert({
        friend_id: friend.id,
        trigger_message: message,
        response_type: 'ai',
        response_sent: true,
        response_content: { type: 'text', text: aiMessage }
      })

  } catch (error) {
    console.error('AI response error:', error)

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (aiSettings?.fallback_message) {
      await sendLineReplyMessage(replyToken, {
        type: 'text',
        text: aiSettings.fallback_message
      })
    }
  }
}

async function sendLineReplyMessage(
  replyToken: string,
  message: any
) {
  const response = await fetch('https://api.line.me/v2/bot/message/reply', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${Deno.env.get('LINE_CHANNEL_ACCESS_TOKEN')}`
    },
    body: JSON.stringify({
      replyToken: replyToken,
      messages: [message]
    })
  })

  if (!response.ok) {
    const errorBody = await response.text()
    throw new Error(`LINE API error: ${errorBody}`)
  }
}
```

---

## 8. AIçµ±åˆè¨­è¨ˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

### 8.1 OpenAIçµ±åˆ

```typescript
// lib/ai/openai-client.ts

import OpenAI from 'openai'

export class OpenAIClient {
  private client: OpenAI

  constructor(apiKey: string) {
    this.client = new OpenAI({ apiKey })
  }

  async chat(
    messages: OpenAI.Chat.ChatCompletionMessageParam[],
    options: {
      model?: string
      temperature?: number
      maxTokens?: number
    } = {}
  ): Promise<string> {
    try {
      const response = await this.client.chat.completions.create({
        model: options.model || 'gpt-3.5-turbo',
        messages: messages,
        temperature: options.temperature || 0.7,
        max_tokens: options.maxTokens || 500
      })

      return response.choices[0].message.content || ''

    } catch (error) {
      console.error('OpenAI API error:', error)
      throw error
    }
  }

  async generateResponse(
    systemPrompt: string,
    conversationHistory: { role: string; content: string }[],
    userMessage: string,
    options?: {
      model?: string
      temperature?: number
      maxTokens?: number
    }
  ): Promise<string> {
    const messages: OpenAI.Chat.ChatCompletionMessageParam[] = [
      {
        role: 'system',
        content: systemPrompt
      },
      ...conversationHistory.map(msg => ({
        role: msg.role as 'user' | 'assistant',
        content: msg.content
      })),
      {
        role: 'user',
        content: userMessage
      }
    ]

    return this.chat(messages, options)
  }
}
```

### 8.2 ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†

```typescript
// lib/ai/prompt-templates.ts

export const promptTemplates = {
  customerSupport: {
    name: 'ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆ',
    systemPrompt: `
ã‚ãªãŸã¯ {business_name} ã®LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆæ‹…å½“ã§ã™ã€‚

ã€åŸºæœ¬æƒ…å ±ã€‘
- å–¶æ¥­æ™‚é–“: {business_hours}
- æä¾›ã‚µãƒ¼ãƒ“ã‚¹: {services}
- ã‚ˆãã‚ã‚‹è³ªå•: {faq}

ã€å¯¾å¿œæ–¹é‡ã€‘
1. ä¸å¯§ã§è¦ªã—ã¿ã‚„ã™ã„å£èª¿ã§å¯¾å¿œã—ã¦ãã ã•ã„
2. ãŠå®¢æ§˜ã®è³ªå•ã«ã¯æ­£ç¢ºã«ç­”ãˆã¦ãã ã•ã„
3. ä¸æ˜ãªç‚¹ã¯æ­£ç›´ã«ã€Œç¢ºèªã—ã¾ã™ã€ã¨ä¼ãˆã¦ãã ã•ã„
4. å–¶æ¥­æ™‚é–“å¤–ã®å ´åˆã¯ç¿Œå–¶æ¥­æ—¥ã®å¯¾å¿œã‚’æ¡ˆå†…ã—ã¦ãã ã•ã„
5. è¤‡é›‘ãªè³ªå•ã«ã¯äººé–“ã®ã‚¹ã‚¿ãƒƒãƒ•ã«å¼•ãç¶™ãã“ã¨ã‚’ææ¡ˆã—ã¦ãã ã•ã„

ã€å‹ã ã¡æƒ…å ±ã€‘
- åå‰: {friend_name}
- ã‚¿ã‚°: {friend_tags}
- éå»ã®å•ã„åˆã‚ã›å±¥æ­´: {friend_history}

ä¸Šè¨˜ã®æƒ…å ±ã‚’å‚è€ƒã«ã€ãŠå®¢æ§˜ã«æœ€é©ãªå›ç­”ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
    `,
    variables: [
      'business_name',
      'business_hours',
      'services',
      'faq',
      'friend_name',
      'friend_tags',
      'friend_history'
    ]
  },

  salesAssistant: {
    name: 'å–¶æ¥­ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ',
    systemPrompt: `
ã‚ãªãŸã¯ {business_name} ã®å–¶æ¥­ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

ã€å•†å“æƒ…å ±ã€‘
{product_info}

ã€ã‚»ãƒ¼ãƒ«ã‚¹ãƒã‚¤ãƒ³ãƒˆã€‘
{selling_points}

ã€å¯¾å¿œæ–¹é‡ã€‘
1. ãŠå®¢æ§˜ã®ãƒ‹ãƒ¼ã‚ºã‚’ç†è§£ã—ã¦ãã ã•ã„
2. é©åˆ‡ãªå•†å“ã‚’ææ¡ˆã—ã¦ãã ã•ã„
3. æŠ¼ã—å£²ã‚Šã¯ã›ãšã€è‡ªç„¶ãªä¼šè©±ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„
4. è³¼å…¥ã‚’å¼·è¦ã›ãšã€æ¤œè¨æ™‚é–“ã‚’ä¸ãˆã¦ãã ã•ã„

ãŠå®¢æ§˜ã«æœ€é©ãªå•†å“ææ¡ˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
    `,
    variables: [
      'business_name',
      'product_info',
      'selling_points'
    ]
  },

  reservationAssistant: {
    name: 'äºˆç´„ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ',
    systemPrompt: `
ã‚ãªãŸã¯ {business_name} ã®äºˆç´„å—ä»˜ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

ã€å–¶æ¥­æ™‚é–“ã€‘
{business_hours}

ã€äºˆç´„å¯èƒ½æ™‚é–“ã€‘
{available_slots}

ã€å¯¾å¿œæ–¹é‡ã€‘
1. äºˆç´„å¸Œæœ›ã‚’ä¸å¯§ã«ãƒ’ã‚¢ãƒªãƒ³ã‚°ã—ã¦ãã ã•ã„
2. ç©ºãçŠ¶æ³ã‚’ç¢ºèªã—ã¦ææ¡ˆã—ã¦ãã ã•ã„
3. å¿…è¦ãªæƒ…å ±ï¼ˆåå‰ã€äººæ•°ã€å¸Œæœ›æ—¥æ™‚ãªã©ï¼‰ã‚’åé›†ã—ã¦ãã ã•ã„
4. æœ€çµ‚ç¢ºèªã‚’å¿…ãšè¡Œã£ã¦ãã ã•ã„

ã‚¹ãƒ ãƒ¼ã‚ºãªäºˆç´„å—ä»˜ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚
    `,
    variables: [
      'business_name',
      'business_hours',
      'available_slots'
    ]
  }
}

export function renderPrompt(
  template: string,
  variables: Record<string, string>
): string {
  let prompt = template

  for (const [key, value] of Object.entries(variables)) {
    const regex = new RegExp(`\\{${key}\\}`, 'g')
    prompt = prompt.replace(regex, value)
  }

  return prompt
}
```

---

## 9. å®Ÿè£…æ‰‹é †

### Day 1-2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰

#### ã‚¿ã‚¹ã‚¯ 1: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
cd lme-saas/supabase/migrations
touch 20251030_auto_response_tables.sql
```

```sql
-- 20251030_auto_response_tables.sql

-- è‡ªå‹•å¿œç­”ãƒ«ãƒ¼ãƒ«ãƒã‚¹ã‚¿
CREATE TABLE auto_response_rules (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  type TEXT NOT NULL CHECK (type IN ('keyword', 'scenario', 'ai')),
  priority INTEGER DEFAULT 10 CHECK (priority BETWEEN 1 AND 100),
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'draft')),
  conditions JSONB DEFAULT '{}',
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- (æ®‹ã‚Šã®ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©...)
-- ã€Œ3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã€ã®SQLã‚’ã‚³ãƒ”ãƒ¼

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
-- ã€Œ3.2 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ã®SQLã‚’ã‚³ãƒ”ãƒ¼

-- RLSæœ‰åŠ¹åŒ–
-- ã€Œ3.3 RLSã€ã®SQLã‚’ã‚³ãƒ”ãƒ¼

-- æ›´æ–°æ—¥æ™‚ã®è‡ªå‹•æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_auto_response_rules_updated_at
BEFORE UPDATE ON auto_response_rules
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_auto_response_scenarios_updated_at
BEFORE UPDATE ON auto_response_scenarios
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_auto_response_ai_settings_updated_at
BEFORE UPDATE ON auto_response_ai_settings
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### ã‚¿ã‚¹ã‚¯ 2: TypeScriptå‹å®šç¾©æ›´æ–°

```bash
# Supabaseå‹ç”Ÿæˆ
npx supabase gen types typescript --local > lme-saas/types/supabase.ts
```

### Day 3-4: Edge Functionå®Ÿè£…

#### ã‚¿ã‚¹ã‚¯ 1: Edge Functionä½œæˆ

```bash
# Edge Functionä½œæˆ
cd lme-saas
mkdir -p supabase/functions/process-auto-response
touch supabase/functions/process-auto-response/index.ts
```

**å†…å®¹**: ã€Œ7.1 process-auto-responseã€ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼

#### ã‚¿ã‚¹ã‚¯ 2: Edge Functionãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤
supabase functions deploy process-auto-response

# ç’°å¢ƒå¤‰æ•°è¨­å®š
supabase secrets set LINE_CHANNEL_ACCESS_TOKEN=your_token
supabase secrets set OPENAI_API_KEY=your_api_key
```

### Day 5-6: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### ã‚¿ã‚¹ã‚¯ 1: Server Actionsä½œæˆ

```bash
# ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
touch lme-saas/app/actions/auto-response.ts
```

**å†…å®¹**: ã€Œ6.1 Server Actionsã€ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼

#### ã‚¿ã‚¹ã‚¯ 2: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ

```bash
# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p lme-saas/components/auto-response

# ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
touch lme-saas/components/auto-response/auto-response-list.tsx
touch lme-saas/components/auto-response/auto-response-stats.tsx
touch lme-saas/components/auto-response/keyword-form.tsx
touch lme-saas/components/auto-response/scenario-form.tsx
touch lme-saas/components/auto-response/ai-settings-form.tsx
```

#### ã‚¿ã‚¹ã‚¯ 3: ãƒšãƒ¼ã‚¸ä½œæˆ

```bash
# ãƒšãƒ¼ã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p lme-saas/app/dashboard/auto-response

# ãƒšãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
touch lme-saas/app/dashboard/auto-response/page.tsx
touch lme-saas/app/dashboard/auto-response/new/page.tsx
touch lme-saas/app/dashboard/auto-response/[id]/page.tsx
touch lme-saas/app/dashboard/auto-response/ai-settings/page.tsx
touch lme-saas/app/dashboard/auto-response/logs/page.tsx
```

### Day 7: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°

#### ã‚¿ã‚¹ã‚¯ 1: å˜ä½“ãƒ†ã‚¹ãƒˆ

```typescript
// tests/auto-response/keyword-matcher.test.ts

describe('KeywordMatcher', () => {
  it('should match exact keyword', () => {
    const result = checkKeywordMatch('ã“ã‚“ã«ã¡ã¯', {
      keyword: 'ã“ã‚“ã«ã¡ã¯',
      match_type: 'exact',
      case_sensitive: false
    })
    expect(result).toBe(true)
  })

  it('should match partial keyword', () => {
    const result = checkKeywordMatch('ã“ã‚“ã«ã¡ã¯ä¸–ç•Œ', {
      keyword: 'ã“ã‚“ã«ã¡ã¯',
      match_type: 'partial',
      case_sensitive: false
    })
    expect(result).toBe(true)
  })

  // ä»–ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹...
})
```

#### ã‚¿ã‚¹ã‚¯ 2: E2Eãƒ†ã‚¹ãƒˆ

```typescript
// tests/e2e/auto-response.spec.ts

import { test, expect } from '@playwright/test'

test('create keyword auto response', async ({ page }) => {
  await page.goto('/dashboard/auto-response')
  await page.click('text=æ–°è¦ä½œæˆ')

  await page.fill('input[name="name"]', 'ãƒ†ã‚¹ãƒˆãƒ«ãƒ¼ãƒ«')
  await page.selectOption('select[name="type"]', 'keyword')
  await page.fill('input[name="keyword"]', 'å–¶æ¥­æ™‚é–“')

  await page.click('button:has-text("ä¿å­˜")')

  await expect(page.locator('text=ãƒ†ã‚¹ãƒˆãƒ«ãƒ¼ãƒ«')).toBeVisible()
})
```

---

## 10. ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

### 10.1 ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¿œç­”ãƒ†ã‚¹ãƒˆ

#### ã‚·ãƒŠãƒªã‚ª 1: å®Œå…¨ä¸€è‡´ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰

```
å‰ææ¡ä»¶:
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œå–¶æ¥­æ™‚é–“ã€ã§å®Œå…¨ä¸€è‡´ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®š
- å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€Œå¹³æ—¥ 9:00-18:00ã€åœŸæ—¥ç¥ 10:00-17:00ã€

ãƒ†ã‚¹ãƒˆæ‰‹é †:
1. LINEå‹ã ã¡ã‹ã‚‰ã€Œå–¶æ¥­æ™‚é–“ã€ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
2. è‡ªå‹•å¿œç­”ãŒè¿”ä¿¡ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. å¿œç­”ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

æœŸå¾…çµæœ:
âœ“ è¨­å®šã—ãŸå¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ä¿¡ã•ã‚Œã‚‹
âœ“ ãƒ­ã‚°ã«ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã‚¿ã‚¤ãƒ—ã§è¨˜éŒ²ã•ã‚Œã‚‹
```

#### ã‚·ãƒŠãƒªã‚ª 2: éƒ¨åˆ†ä¸€è‡´ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰

```
å‰ææ¡ä»¶:
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€Œäºˆç´„ã€ã§éƒ¨åˆ†ä¸€è‡´ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®š
- å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€Œã”äºˆç´„ã¯ã“ã¡ã‚‰ã‹ã‚‰...ã€

ãƒ†ã‚¹ãƒˆæ‰‹é †:
1. ã€Œäºˆç´„ã—ãŸã„ã€ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
2. ã€Œäºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆé™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«"ï¼‰

æœŸå¾…çµæœ:
âœ“ ã€Œäºˆç´„ã—ãŸã„ã€â†’ å¿œç­”ã‚ã‚Š
âœ“ ã€Œäºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€â†’ å¿œç­”ãªã—ï¼ˆé™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒï¼‰
```

### 10.2 ã‚·ãƒŠãƒªã‚ªå¿œç­”ãƒ†ã‚¹ãƒˆ

#### ã‚·ãƒŠãƒªã‚ª 3: å¤šæ®µéšä¼šè©±ãƒ•ãƒ­ãƒ¼

```
å‰ææ¡ä»¶:
- äºˆç´„å—ä»˜ã‚·ãƒŠãƒªã‚ªã‚’è¨­å®šï¼ˆ4ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

ãƒ†ã‚¹ãƒˆæ‰‹é †:
1. ã€Œäºˆç´„ã€ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ â†’ ã‚¹ãƒ†ãƒƒãƒ—1é–‹å§‹
2. ã€Œå±±ç”°å¤ªéƒã€ã¨åå‰å…¥åŠ› â†’ ã‚¹ãƒ†ãƒƒãƒ—2ã¸
3. ã€Œ12/25 14:00ã€ã¨æ—¥æ™‚å…¥åŠ› â†’ ã‚¹ãƒ†ãƒƒãƒ—3ã¸
4. ã€Œã¯ã„ã€ã§ç¢ºå®š â†’ å®Œäº†

æœŸå¾…çµæœ:
âœ“ å„ã‚¹ãƒ†ãƒƒãƒ—ã§é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ä¿¡ã•ã‚Œã‚‹
âœ“ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã‚‹
âœ“ å®Œäº†æ™‚ã«ã‚¿ã‚°ãŒä»˜ä¸ã•ã‚Œã‚‹
âœ“ äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒä½œæˆã•ã‚Œã‚‹
```

#### ã‚·ãƒŠãƒªã‚ª 4: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼

```
å‰ææ¡ä»¶:
- æ—¥æ™‚å…¥åŠ›ã‚¹ãƒ†ãƒƒãƒ—ã§æ—¥ä»˜å½¢å¼ãƒã‚§ãƒƒã‚¯

ãƒ†ã‚¹ãƒˆæ‰‹é †:
1. ã‚·ãƒŠãƒªã‚ªé–‹å§‹
2. åå‰å…¥åŠ›
3. ç„¡åŠ¹ãªæ—¥æ™‚ã€Œã‚ã—ãŸã€ã‚’å…¥åŠ›

æœŸå¾…çµæœ:
âœ“ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ä¿¡ã•ã‚Œã‚‹
âœ“ åŒã˜ã‚¹ãƒ†ãƒƒãƒ—ã«ç•™ã¾ã‚‹
âœ“ å†åº¦å…¥åŠ›ã‚’ä¿ƒã•ã‚Œã‚‹
```

### 10.3 æ¡ä»¶åˆ†å²ãƒ†ã‚¹ãƒˆ

#### ã‚·ãƒŠãƒªã‚ª 5: æ™‚é–“å¸¯ã«ã‚ˆã‚‹å‡ºã—åˆ†ã‘

```
å‰ææ¡ä»¶:
- å–¶æ¥­æ™‚é–“å†…(9:00-18:00): ã€Œæ‹…å½“è€…ãŒå¯¾å¿œã—ã¾ã™ã€
- å–¶æ¥­æ™‚é–“å¤–: ã€Œå–¶æ¥­æ™‚é–“å¤–ã§ã™ã€‚ç¿Œå–¶æ¥­æ—¥ã«ã”é€£çµ¡ã—ã¾ã™ã€

ãƒ†ã‚¹ãƒˆæ‰‹é †:
1. 10:00ã«ã€Œã“ã‚“ã«ã¡ã¯ã€é€ä¿¡
2. 20:00ã«ã€Œã“ã‚“ã«ã¡ã¯ã€é€ä¿¡

æœŸå¾…çµæœ:
âœ“ 10:00 â†’ å–¶æ¥­æ™‚é–“å†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
âœ“ 20:00 â†’ å–¶æ¥­æ™‚é–“å¤–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```

#### ã‚·ãƒŠãƒªã‚ª 6: ã‚¿ã‚°ã«ã‚ˆã‚‹å‡ºã—åˆ†ã‘

```
å‰ææ¡ä»¶:
- VIPã‚¿ã‚°ã‚ã‚Š: ã€ŒVIPå°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€
- VIPã‚¿ã‚°ãªã—: ã€Œé€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€

ãƒ†ã‚¹ãƒˆæ‰‹é †:
1. VIPã‚¿ã‚°ä»˜ãå‹ã ã¡ã‹ã‚‰é€ä¿¡
2. ã‚¿ã‚°ãªã—å‹ã ã¡ã‹ã‚‰é€ä¿¡

æœŸå¾…çµæœ:
âœ“ ãã‚Œãã‚Œé©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ä¿¡ã•ã‚Œã‚‹
```

### 10.4 AIå¿œç­”ãƒ†ã‚¹ãƒˆ

#### ã‚·ãƒŠãƒªã‚ª 7: AIå¿œç­”ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

```
å‰ææ¡ä»¶:
- AIå¿œç­”ã‚’æœ‰åŠ¹åŒ–
- ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šæ¸ˆã¿

ãƒ†ã‚¹ãƒˆæ‰‹é †:
1. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ãƒãƒƒãƒã—ãªã„è³ªå•ã€Œé…é€æ–¹æ³•ã¯ï¼Ÿã€ã‚’é€ä¿¡
2. AIå¿œç­”ãŒè¿”ä¿¡ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. ä¼šè©±å±¥æ­´ã«ä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

æœŸå¾…çµæœ:
âœ“ ChatGPTã‹ã‚‰é©åˆ‡ãªå¿œç­”ãŒç”Ÿæˆã•ã‚Œã‚‹
âœ“ ä¼šè©±å±¥æ­´ã«è¨˜éŒ²ã•ã‚Œã‚‹
âœ“ ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ãŒè¨˜éŒ²ã•ã‚Œã‚‹
```

---

## ã¾ã¨ã‚

### å®Ÿè£…å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆ7ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»RLSè¨­å®š
- [ ] TypeScriptå‹å®šç¾©ç”Ÿæˆ
- [ ] Edge Functionå®Ÿè£…ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] Server Actionså®Ÿè£…
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
- [ ] ãƒšãƒ¼ã‚¸å®Ÿè£…ï¼ˆ5ãƒšãƒ¼ã‚¸ï¼‰
- [ ] ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°æ©Ÿèƒ½
- [ ] ã‚·ãƒŠãƒªã‚ªç®¡ç†æ©Ÿèƒ½
- [ ] ä¼šè©±çŠ¶æ…‹ç®¡ç†æ©Ÿèƒ½
- [ ] æ¡ä»¶è©•ä¾¡ã‚¨ãƒ³ã‚¸ãƒ³
- [ ] å¿œç­”ãƒ­ã‚°æ©Ÿèƒ½
- [ ] AIçµ±åˆæ©Ÿèƒ½ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆ
- [ ] E2Eãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™

### æˆæœç‰©

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**
   - 7ãƒ†ãƒ¼ãƒ–ãƒ« + ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ + RLS

2. **Edge Functions**
   - `process-auto-response`: è‡ªå‹•å¿œç­”å‡¦ç†

3. **Server Actions**
   - ãƒ«ãƒ¼ãƒ«CRUD
   - ã‚·ãƒŠãƒªã‚ªCRUD
   - ãƒ­ã‚°å–å¾—
   - AIè¨­å®šç®¡ç†

4. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**
   - è‡ªå‹•å¿œç­”ä¸€è¦§ç”»é¢
   - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¿œç­”ä½œæˆç”»é¢
   - ã‚·ãƒŠãƒªã‚ªå¿œç­”ä½œæˆç”»é¢
   - AIè¨­å®šç”»é¢
   - å¿œç­”ãƒ­ã‚°ç”»é¢

5. **ãƒ†ã‚¹ãƒˆ**
   - å˜ä½“ãƒ†ã‚¹ãƒˆ
   - E2Eãƒ†ã‚¹ãƒˆ

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

Phase 7å®Œäº†å¾Œã¯ä»¥ä¸‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ï¼š

1. **Phase 8: ã‚·ã‚¹ãƒ†ãƒ è¨­å®š** - çµ„ç¹”è¨­å®šã€ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã€è«‹æ±‚ç®¡ç†
2. **Phase 9: é«˜åº¦ãªåˆ†æ** - ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ãƒãƒ¼ãƒˆã€A/Bãƒ†ã‚¹ãƒˆã€ãƒ•ã‚¡ãƒãƒ«åˆ†æ
3. **Phase 10: çµ±åˆãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–** - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

---

**Phase 7è¦ä»¶åˆ†æå®Œäº†ï¼** ğŸ‰

ã“ã®å®Ÿè£…è¨ˆç”»æ›¸ã«å¾“ã£ã¦ã€è‡ªå‹•å¿œç­”æ©Ÿèƒ½ã®å®Œå…¨ãªå®Ÿè£…ãŒå¯èƒ½ã§ã™ã€‚
